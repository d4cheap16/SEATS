const updateSeatNumber = (r, c, type, value) => {
                const key = `${r}-${c}`;
                const currentSeat = seats[key] || { number: '', status: 'empty' };
                const currentVal = currentSeat.number || '';
                
                let [currentClass, currentNum] = currentVal.includes('-') 
                    ? currentVal.split('-') 
                    : ['', currentVal];
                
                if (seatMode === 'single') {
                    if (type === 'seat') {
                        setSeats(prev => ({ ...prev, [key]: { number: value } }));
                    }
                } else {
                    if (!currentVal.includes('-')) {
                        currentNum = currentVal;
                        currentClass = '';
                    }

                    let newClass = currentClass;
                    let newNum = currentNum;

                    if (type === 'class') newClass = value; 
                    if (type === 'seat') {
                        newNum = value; 
                        if (!newClass && config.defaultClass && newNum.trim()) {
                            newClass = config.defaultClass;
                        }
                    }

                    let newVal = '';
                    if (newClass && !newNum) newVal = `${newClass}-`;
                    else if (!newClass && newNum) newVal = newNum;
                    else if (newClass && newNum) newVal = `${newClass}-${newNum}`;
                    else newVal = '';
                    
                    setSeats(prev => ({ ...prev, [key]: { number: newVal } }));
                }
            };

            const handleKeyDown = (e, r, c, type) => {
                let targetR = r; let targetC = c;
                if (e.key === 'Enter') {
                    if (type === 'class') {
                        const targetKey = `${r}-${c}-seat`;
                        if (inputRefs.current[targetKey]) { 
                            e.preventDefault(); 
                            inputRefs.current[targetKey].focus(); 
                        }
                        return;
                    }
                }

                if (e.key === 'ArrowUp') targetR = Math.max(0, r - 1);
                else if (e.key === 'ArrowDown') targetR = Math.min(config.rows - 1, r + 1);
                else if (e.key === 'ArrowLeft') targetC = Math.max(0, c - 1);
                else if (e.key === 'ArrowRight') targetC = Math.min(config.cols - 1, c + 1);
                else return;
                
                const targetKey = `${targetR}-${targetC}-seat`; 
                if (inputRefs.current[targetKey]) { 
                    e.preventDefault(); 
                    inputRefs.current[targetKey].focus(); 
                }
            };

            const handleAddClassToRoster = () => {
                if (!helperStudentList.trim()) return;
                let newText = rosterText.trim();
                if (newText) newText += '\n\n';
                if (helperClassName.trim()) { newText += `[${helperClassName.trim()}]\n`; }
                newText += helperStudentList.trim();
                setRosterText(newText);
                setHelperClassName('');
                setHelperStudentList('');
            };

            const isClassValid = !config.defaultClass || availableClasses.includes(config.defaultClass.trim());

            // ====================================================================
            // ▼ 匯出與預覽邏輯 (修正版) ▼
            // ====================================================================
            const generatePdfContent = () => {
                const pdfContainer = document.getElementById('pdf-export-container');
                if (!pdfContainer) return;

                pdfContainer.innerHTML = '';
                
                // 1. 標題
                const title = document.createElement('h1');
                title.style.cssText = 'font-size: 36pt; font-weight: 900; margin-bottom: 20px; color: #000; text-align: center; flex-shrink: 0;';
                title.textContent = config.systemTitle || (seatMode === 'single' ? '班級座位表' : '考場座位表');
                pdfContainer.appendChild(title);

                // 2. 表格 (座位) - 現在放在中間
                const tableWrapper = document.createElement('div');
                tableWrapper.style.cssText = `flex-grow: 1; display: flex; flex-direction: column; justify-content: center; width: 100%;`;
                
                const table = document.createElement('table');
                table.className = 'export-table';
                const tbody = document.createElement('tbody');
                
                // 重要修正：教師視角，從最靠近講台的列開始（原本的 Row 0 顯示在最下方，但現在講台在下方，所以邏輯要反轉）
                // 為了讓螢幕上的「上方第一列」變成紙張上的「下方第一列」（靠近講台），我們需要反向遍歷列。
                for (let r = config.rows - 1; r >= 0; r--) {
                    const tr = document.createElement('tr');
                    for (let c = 0; c < config.cols; c++) {
                        const td = document.createElement('td');
                        td.className = 'export-cell';
                        const minHeight = Math.floor(200 / config.rows); 
                        td.style.height = `${minHeight}mm`;

                        const key = `${r}-${c}`;
                        const seat = seats[key] || { number: '' };
                        
                        // 資料處理
                        let displayNum = '';
                        let displayClass = '';
                        let displayStudentName = '';

                        const [classPart, seatPart] = seat.number.includes('-') 
                            ? seat.number.split('-') 
                            : ['', seat.number];

                        if (seatMode === 'single') {
                            displayNum = seatPart || seat.number;
                            const studentData = rosterMap[seat.number] || rosterMap[`${config.systemTitle}-${seat.number}`];
                            displayStudentName = studentData?.name || '';
                        } else {
                            displayClass = classPart;
                            displayNum = seatPart || seat.number;
                            const studentData = rosterMap[seat.number];
                            displayStudentName = studentData?.name || '';
                        }
                        
                        // 內容容器 (垂直置中)
                        const contentWrapper = document.createElement('div');
                        contentWrapper.className = 'cell-content-wrapper';

                        // 班級標籤 (修正：內容水平與垂直置中)
                        if (seatMode === 'mixed' && displayClass.trim()) {
                            const classDiv = document.createElement('div');
                            classDiv.textContent = displayClass;
                            const color = getClassColor(displayClass).replace('bg-', '');
                            const colorMap = {
                                'blue-600': '#2563eb', 'emerald-600': '#059669', 'violet-600': '#7c3aed',
                                'orange-600': '#ea580c', 'pink-600': '#db2777', 'cyan-600': '#0891b2',
                                'fuchsia-600': '#c026d3', 'lime-700': '#4d7c0f', 'sky-600': '#0284c7', 'indigo-600': '#4f46e5'
                            };
                            const bgColor = colorMap[color] || '#4b5563';
                            
                            // 關鍵修正：加入 display: flex; justify-content: center; align-items: center; line-height: 1;
                            classDiv.style.cssText = `
                                position: absolute; 
                                top: 4px; 
                                left: 50%; 
                                transform: translateX(-50%); 
                                background-color: ${bgColor};
                                color: white; 
                                font-size: 8pt; 
                                font-weight: bold; 
                                padding: 3px 8px; /* 稍微調整 padding */
                                border-radius: 4px; 
                                text-align: center; 
                                white-space: nowrap;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                line-height: 1;
                            `;
                            td.appendChild(classDiv);
                        }

                        // 座號
                        const numberDiv = document.createElement('div');
                        numberDiv.style.cssText = `font-size: 28pt; font-weight: 900; color: #1e293b; line-height: 1; margin-bottom: 4px;`;
                        numberDiv.textContent = displayNum.trim() || '-';
                        contentWrapper.appendChild(numberDiv);

                        // 姓名
                        const nameDiv = document.createElement('div');
                        nameDiv.style.cssText = `font-size: 16pt; font-weight: 700; color: #334155;`;
                        nameDiv.textContent = displayStudentName || '';
                        contentWrapper.appendChild(nameDiv);

                        td.appendChild(contentWrapper);
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }
                table.appendChild(tbody);
                tableWrapper.appendChild(table);
                pdfContainer.appendChild(tableWrapper);

                // 3. 講台 (移到最下方，並強制置中)
                const podium = document.createElement('div');
                // 關鍵修正：確保 display: flex 與 align-items: center 運作正常
                podium.style.cssText = `
                    width: 100%; 
                    height: 20mm; 
                    background-color: #f1f5f9; 
                    border: 2px solid #64748b;
                    border-radius: 8px; 
                    display: flex; 
                    justify-content: center; 
                    align-items: center;
                    font-size: 18pt; 
                    font-weight: 700; 
                    color: #334155; 
                    margin-top: 10px; 
                    flex-shrink: 0;
                    line-height: 1; /* 避免文字垂直偏移 */
                `;
                podium.textContent = '講台 (Podium)';
                pdfContainer.appendChild(podium);

                exportRef.current = pdfContainer;
            };

            const handlePreview = async () => {
                setIsExporting(true);
                generatePdfContent();
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    const canvas = await html2canvas(exportRef.current, {
                        scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff', windowWidth: 2480,
                    });
                    const imgData = canvas.toDataURL('image/png');
                    setPreviewData(imgData); 
                } catch (error) {
                    console.error('預覽失敗:', error);
                    alert('預覽生成失敗。');
                } finally {
                    setIsExporting(false);
                }
            };

            const downloadPdf = () => {
                if (!previewData) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(previewData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                const yPos = (pdfHeight - imgHeight) / 2;
                pdf.addImage(previewData, 'PNG', 0, Math.max(0, yPos), pdfWidth, imgHeight);
                pdf.save(`${config.systemTitle || '座位表'}.pdf`);
                setPreviewData(null);
            };

            const downloadImage = () => {
                if (!previewData) return;
                const a = document.createElement('a');
                a.href = previewData;
                a.download = `${config.systemTitle || '座位表'}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setPreviewData(null);
            };
            // ====================================================================

            if (isAdminMode) return <AdminPanel onBack={() => setIsAdminMode(false)} onEnterClass={(id) => { setIsAdminMode(false); setActiveClassroom(id); }} />;
            if (!activeClassroom) return <LoginScreen onLogin={setActiveClassroom} onAdminLogin={() => setIsAdminMode(true)} />;

            return (
                <div className="h-screen w-screen flex flex-col bg-slate-900 text-slate-100 overflow-hidden font-mono select-none">
                    {/* Navbar */}
                    <div className="shrink-0 w-full bg-gray-300 text-gray-800 p-2 flex justify-between items-center border-b-4 border-gray-400 shadow-lg z-20 relative">
                        <div className="flex items-center gap-4">
                            {/* 模式切換開關 */}
                            <div className="bg-white rounded-lg p-1 flex shadow-inner border border-gray-300 ml-2">
                                <button 
                                    onClick={() => setSeatMode('single')}
                                    className={`px-3 py-1 rounded text-xs font-bold transition-all flex items-center gap-1 ${seatMode === 'single' ? 'bg-blue-600 text-white shadow' : 'text-gray-500 hover:bg-gray-100'}`}
                                >
                                    <Icon name="user" size={14}/> 單一班級
                                </button>
                                <button 
                                    onClick={() => setSeatMode('mixed')}
                                    className={`px-3 py-1 rounded text-xs font-bold transition-all flex items-center gap-1 ${seatMode === 'mixed' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-gray-100'}`}
                                >
                                    <Icon name="users" size={14}/> 混合班級
                                </button>
                            </div>

                            <input 
                                type="text" 
                                className="font-black text-xl tracking-widest text-gray-700 bg-transparent border-b-2 border-gray-500 outline-none hidden md:block placeholder-gray-400 w-64 select-text" 
                                value={config.systemTitle || ''} 
                                placeholder={seatMode === 'single' ? "請輸入班級名稱 (例如: 高一仁)" : "請輸入考場名稱 (例如: 第01試場)"} 
                                onChange={(e) => setConfig({...config, systemTitle: e.target.value})} 
                            />
                            
                            {/* 僅在混合模式顯示預設班級 */}
                            {seatMode === 'mixed' && (
                                <div className="hidden md:flex items-center gap-2 ml-2 border-l pl-4 border-gray-400 relative">
                                    <span className="text-xs font-bold text-gray-500">預設班級:</span>
                                    <div className="relative">
                                        <input 
                                            list="class-options"
                                            type="text" 
                                            className={`w-24 bg-white border-2 rounded px-2 py-1 text-sm font-bold placeholder-gray-300 focus:outline-none transition-colors ${!isClassValid ? 'border-red-500 text-red-600 focus:border-red-600' : 'border-gray-300 text-blue-600 focus:border-blue-500'}`} 
                                            placeholder="例如:301" 
                                            value={config.defaultClass || ''} 
                                            onChange={(e) => setConfig({...config, defaultClass: e.target.value})} 
                                        />
                                        {!isClassValid && (
                                            <div className="absolute top-full left-0 mt-1 bg-red-500 text-white text-[10px] px-1 rounded whitespace-nowrap z-50 shadow-lg animate-bounce">
                                                ⚠️ 名單無此班級
                                            </div>
                                        )}
                                    </div>
                                    <datalist id="class-options">
                                        {availableClasses.map(c => <option key={c} value={c} />)}
                                    </datalist>
                                </div>
                            )}

                            <button onClick={saveToCloud} disabled={syncStatus === 'saving'} className={`flex items-center gap-2 px-3 py-1 rounded-full border-inner shadow-inner transition-colors ${syncStatus === 'saved' ? 'bg-green-100' : 'bg-gray-200 hover:bg-gray-300'} ml-2`} title="手動儲存">
                                {syncStatus === 'loading' ? <Icon name="refresh-cw" className="animate-spin text-blue-500" size={14} /> : syncStatus === 'saving' ? <Icon name="cloud-upload" className="animate-bounce text-blue-500" size={14} /> : syncStatus === 'saved' ? <Icon name="check" className="text-green-600" size={14} /> : syncStatus === 'error' ? <Icon name="cloud-off" className="text-red-500" size={14} /> : <Icon name="save" className="text-gray-600" size={14} />}
                                <span className={`text-xs font-bold ${syncStatus === 'saved' ? 'text-green-700' : 'text-gray-600'}`}>{syncStatus === 'loading' ? '讀取...' : syncStatus === 'saving' ? '儲存中...' : syncStatus === 'saved' ? '已儲存' : syncStatus === 'error' ? '失敗' : '點此存檔'}</span>
                            </button>

                            <button onClick={handleClearSeats} className="flex items-center gap-2 px-3 py-1 rounded-full border-inner shadow-inner transition-colors bg-red-100 hover:bg-red-200 ml-2" title="清空所有座位">
                                <Icon name="trash-2" className="text-red-600" size={14} />
                                <span className="text-xs font-bold text-red-700">清空</span>
                            </button>
                        </div>
                        <div className="flex gap-2">
                            {/* 匯出預覽按鈕 */}
                            <button 
                                onClick={handlePreview} 
                                disabled={isExporting}
                                className="px-4 py-1.5 rounded-lg font-bold flex items-center gap-2 text-sm transition-all bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 disabled:bg-gray-400 border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1"
                            >
                                {isExporting ? <Icon name="loader-2" className="animate-spin" size={16} /> : <Icon name="eye" size={16} />} 預覽與匯出
                            </button>
                            
                            <button onClick={() => setShowSettings(true)} className="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg border-b-4 border-gray-400 hover:bg-white active:border-b-0 active:translate-y-1 flex items-center gap-1 text-sm"><Icon name="settings" size={16} /> 設定</button>
                            <button onClick={() => setActiveClassroom(null)} className="px-3 py-1.5 bg-red-500 text-white rounded-lg font-bold border-b-4 border-red-700 hover:bg-red-400 active:border-b-0 active:translate-y-1 text-sm flex items-center" title="登出"><Icon name="log-out" size={16} /></button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex w-full overflow-hidden relative p-4 gap-4">
                        
                        {/* Left Section: Seat Grid */}
                        <div className="flex-1 bg-slate-800 rounded-xl p-2 md:p-4 pixel-border relative flex flex-col border-4 border-gray-700 overflow-hidden">
                            {/* Podium */}
                            <div className="w-full h-12 bg-amber-700 text-amber-100 rounded-lg border-b-4 border-amber-900 shadow-lg flex items-center justify-center relative overflow-hidden group mb-4 shrink-0">
                                <Icon name="monitor" size={32} />
                                <span className="ml-4 font-bold text-xl">講台 (Podium)</span>
                            </div>

                            {/* Seat Grid */}
                            <div className="flex-1 w-full h-full pb-2 overflow-y-auto no-scrollbar">
                                <div className="grid gap-2 h-full w-full" style={{ gridTemplateColumns: `repeat(${config.cols}, 1fr)` }}>
                                    {Array.from({ length: config.rows }).map((_, r) => (
                                        Array.from({ length: config.cols }).map((_, c) => {
                                            const key = `${r}-${c}`;
                                            const seat = seats[key] || { number: '' };
                                            const studentData = rosterMap[seat.number];
                                            const studentName = studentData?.name || '';
                                            
                                            const isDuplicate = seat.number && duplicateNumbers.has(seat.number);

                                            // 資料解析
                                            const [editClass, editSeat] = seat.number.includes('-') 
                                                ? seat.number.split('-') 
                                                : ['', seat.number];

                                            const isCellClassValid = !editClass || availableClasses.includes(editClass.trim());

                                            let containerClasses = "relative w-full h-full p-1 rounded border-b-4 transition-all flex flex-col items-center justify-center shadow-lg select-none ";

                                            if (seatMode === 'mixed' && !isCellClassValid && editClass) {
                                                containerClasses += "bg-orange-500 border-orange-700 text-white"; 
                                            } else if (isDuplicate) {
                                                containerClasses += "bg-red-100 border-red-500 text-red-900 ring-2 ring-red-500";
                                            } else if (seat.number) {
                                                containerClasses += "bg-slate-100 border-slate-300 text-slate-900 hover:bg-white cursor-pointer";
                                            } else {
                                                containerClasses += "bg-slate-700 border-slate-900 opacity-30";
                                            }

                                            return (
                                                <div key={key} className={containerClasses}>
                                                    <div className="flex flex-col w-full items-center justify-center gap-1">
                                                        {/* 僅在混合模式顯示班級輸入 */}
                                                        {seatMode === 'mixed' && (
                                                            <input 
                                                                type="text"
                                                                placeholder={config.defaultClass || "班級"}
                                                                className={`w-full text-center bg-transparent outline-none text-xs md:text-sm font-bold p-0 placeholder-gray-500 transition-colors ${!isCellClassValid ? 'text-white font-black placeholder-white/50' : (editClass ? 'text-blue-400' : 'text-gray-500')}`}
                                                                value={editClass}
                                                                onChange={(e) => updateSeatNumber(r, c, 'class', e.target.value)}
                                                                onKeyDown={(e) => handleKeyDown(e, r, c, 'class')}
                                                                title={!isCellClassValid ? "⚠️ 名單無此班級" : ""}
                                                            />
                                                        )}
                                                        
                                                        <input 
                                                            ref={el => inputRefs.current[`${key}-seat`] = el} 
                                                            type="text"
                                                            placeholder="座號"
                                                            className={`w-full text-center bg-transparent outline-none font-bold text-2xl md:text-4xl border-b border-gray-400/50 focus:border-blue-500 p-0 select-text ${!isCellClassValid && seatMode === 'mixed' ? 'text-white border-white/50' : (isDuplicate ? 'text-red-600 border-red-400' : (seat.number ? 'text-slate-900' : 'text-white'))}`} 
                                                            // 單一模式只顯示座號部分，混合模式顯示座號部分(editSeat)
                                                            value={seatMode === 'single' ? (seat.number) : editSeat} 
                                                            onChange={(e) => updateSeatNumber(r, c, 'seat', e.target.value)} 
                                                            onKeyDown={(e) => handleKeyDown(e, r, c, 'seat')} 
                                                        />
                                                    </div>
                                                    
                                                    {/* 僅在混合模式顯示班級標籤 */}
                                                    {seatMode === 'mixed' && editClass && (
                                                        <div className={`absolute top-1 left-1 class-badge ${getClassColor(editClass)} text-white`}>
                                                            {editClass}
                                                        </div>
                                                    )}

                                                    {seat.number && (
                                                        <div className={`text-sm md:text-xl font-bold truncate w-full text-center px-0.5 leading-tight mt-1 ${(!isCellClassValid && seatMode === 'mixed') ? 'text-white' : (isDuplicate ? 'text-red-600' : 'text-slate-600')}`}>{studentName || ''}</div>
                                                    )}
                                                    
                                                    {isDuplicate && <div className="absolute top-1 right-1 bg-yellow-400 text-red-900 text-[10px] font-bold px-1 rounded shadow z-10 animate-pulse">重複!</div>}
                                                </div>
                                            );
                                        })
                                    ))}
                                </div>
                            </div>
                        </div>
