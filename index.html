<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座位編排專用系統</title>
    
    <!-- 載入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 React 和 Babel (核心運算) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 載入 Lucide Icons (圖示) -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <!-- 匯出 PDF/圖片所需函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- 自定義樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', monospace; }
        .pixel-border {
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.3);
        }
        
        /* 隱藏捲軸但保留捲動功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* 隱藏 number input 的上下箭頭 */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* 班級標籤樣式 */
        .class-badge {
            font-size: 1.7rem; 
            line-height: 1.2;
            padding: 6px 8px;   
            border-radius: 6px;
            font-weight: 900;
            letter-spacing: 0.05em;
            box-shadow: 2px 2px 3px rgba(0,0,0,0.2);
            text-shadow: 0px 1px 2px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* === PDF 匯出容器樣式 (隱藏於底層) === */
        #pdf-export-container {
            width: 210mm; /* A4 寬度 */
            min-height: 297mm; /* A4 高度 */
            padding: 15mm;
            background-color: white;
            color: black;
            position: fixed; 
            top: 0;
            left: 0;
            z-index: -9999;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif; 
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
        }
        
        /* 匯出用的 Table 樣式 */
        .export-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 8px; /* 座位間距 */
            table-layout: fixed;
            margin: auto 0; /* 垂直置中 */
        }
        .export-cell {
            border: 2px solid #94a3b8; /* slate-400 */
            background-color: #f8fafc; /* slate-50 */
            border-radius: 8px;
            text-align: center;
            vertical-align: middle;
            padding: 4px;
            box-sizing: border-box;
            position: relative;
            display: table-cell;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>
    <!-- PDF 匯出用的隱藏容器 -->
    <div id="pdf-export-container"></div>

    <!-- 主程式邏輯 -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ==========================================
        // ▼ 您的 Firebase Config ▼
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBd1OUQ2wwEOSIezzhsuuYcjZSXJPn-WnI",
          authDomain: "examseat-508e9.firebaseapp.com",
          projectId: "examseat-508e9",
          storageBucket: "examseat-508e9.firebasestorage.app",
          messagingSenderId: "959964513566",
          appId: "1:959964513566:web:88dac9c40c5993a90a750f"
        };
        // ==========================================

        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.projectId;
        let app, auth, db;
        if (isFirebaseConfigured) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }
        const appId = "examseat-508e9";

        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Constants ---
        const ADMIN_HASH = "667d3b4405324cb53a755b5eb6c0d5370322527a32f75964d9a040230d273033";

        // 班級顏色池
        const CLASS_COLORS = [
            'bg-blue-600', 'bg-emerald-600', 'bg-violet-600', 
            'bg-orange-600', 'bg-pink-600', 'bg-cyan-600', 
            'bg-fuchsia-600', 'bg-lime-700', 'bg-sky-600', 'bg-indigo-600'
        ];

        // 預設名單
        const DEFAULT_ROSTER = `[高一OO班]
01\t王小美
02\t王小明
03\t陳小華
04\t林大衛
05\t張曉芬
06\t李大同
07\t黃小玉
08\t周杰倫
09\t蔡依林
10\t五月天`;
        
        // --- Helpers ---
        const getClassColor = (className) => {
            if (!className) return 'bg-slate-800';
            let hash = 0;
            for (let i = 0; i < className.length; i++) {
                hash = className.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % CLASS_COLORS.length;
            return CLASS_COLORS[index];
        };

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer)); 
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- Components ---
        // AdminPanel 和 LoginScreen 保持不變
        const AdminPanel = ({ onBack, onEnterClass }) => {
            const [classList, setClassList] = useState([]);
            const [loading, setLoading] = useState(true);

            const fetchClasses = async () => {
                if (!db) return;
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'classrooms'));
                    const list = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.config) {
                             list.push({
                                id: doc.id,
                                lastUpdated: data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : '未知',
                                ...data
                            });
                        }
                    });
                    list.sort((a, b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0));
                    setClassList(list);
                } catch (error) {
                    console.error("讀取失敗:", error);
                    alert("讀取失敗，請確認資料庫權限設定。");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchClasses(); }, []);

            const handleDelete = async (id) => {
                if (confirm(`確定要永久刪除班級「${id}」嗎？`)) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', id));
                        setClassList(prev => prev.filter(c => c.id !== id));
                    } catch (error) { alert("刪除失敗"); }
                }
            };

            return (
                <div className="flex flex-col items-center min-h-screen bg-slate-900 text-slate-100 p-4 font-mono">
                    <div className="w-full max-w-4xl">
                        <div className="flex justify-between items-center mb-6 bg-red-900/50 p-4 rounded-xl border-l-4 border-red-500">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-red-600 rounded-lg shadow-lg"><Icon name="shield-alert" size={32} className="text-white" /></div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-widest text-white">ADMIN DASHBOARD</h1>
                                    <p className="text-red-200 text-sm">系統管理介面</p>
                                </div>
                            </div>
                            <button onClick={onBack} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg flex items-center gap-2 font-bold transition-all">
                                <Icon name="log-out" size={18} /> 登出
                            </button>
                        </div>

                        <div className="bg-slate-800 rounded-xl pixel-border border-4 border-gray-700 overflow-hidden shadow-2xl">
                            <div className="p-4 border-b-2 border-gray-700 flex justify-between items-center bg-slate-750">
                                <h2 className="font-bold text-lg flex items-center gap-2"><Icon name="list" /> 班級列表 ({classList.length})</h2>
                                <button onClick={fetchClasses} className="p-2 hover:bg-slate-600 rounded-full"><Icon name="refresh-cw" size={18} /></button>
                            </div>
                            
                            {loading ? (
                                <div className="p-8 text-center text-gray-400 flex flex-col items-center gap-2">
                                    <Icon name="loader-2" className="animate-spin" size={32} />
                                    讀取中...
                                </div>
                            ) : classList.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">無班級資料</div>
                            ) : (
                                <div className="max-h-[70vh] overflow-y-auto no-scrollbar">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-900 text-gray-400 sticky top-0 z-10 shadow-md">
                                            <tr>
                                                <th className="p-4 font-bold">班級代碼</th>
                                                <th className="p-4 font-bold hidden md:table-cell">顯示名稱</th>
                                                <th className="p-4 font-bold hidden sm:table-cell">最後更新</th>
                                                <th className="p-4 font-bold text-right">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-700">
                                            {classList.map(cls => (
                                                <tr key={cls.id} className="hover:bg-slate-700/50 transition-colors">
                                                    <td className="p-4 font-bold text-yellow-400 font-mono text-lg">{cls.id}</td>
                                                    <td className="p-4 text-gray-300 hidden md:table-cell">{cls.config?.systemTitle || '-'}</td>
                                                    <td className="p-4 text-gray-500 text-sm hidden sm:table-cell">{cls.lastUpdated}</td>
                                                    <td className="p-4 text-right space-x-2">
                                                        <button 
                                                            onClick={() => onEnterClass(cls.id)}
                                                            className="inline-flex items-center gap-1 px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold"
                                                        >
                                                            <Icon name="log-in" size={14} /> 進入
                                                        </button>
                                                        <button 
                                                            onClick={() => handleDelete(cls.id)}
                                                            className="inline-flex items-center gap-1 px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm font-bold"
                                                        >
                                                            <Icon name="trash-2" size={14} /> 刪除
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, onAdminLogin }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');

            // 自動填入最後一次的班級代碼
            useEffect(() => {
                const lastId = localStorage.getItem('last_active_classroom');
                if (lastId) {
                    setInput(lastId);
                }
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const code = input.trim();
                if (!code) { setError('請輸入代碼'); return; }
                
                try {
                    if (window.crypto && window.crypto.subtle) {
                        const hash = await sha256(code);
                        if (hash === ADMIN_HASH) {
                            onAdminLogin();
                            return;
                        }
                    } else {
                        if (code === 'Makima777') {
                             onAdminLogin();
                             return;
                        }
                    }
                } catch (e) {
                    console.warn("Hashing check skipped, using fallback", e);
                    if (code === 'Makima777') {
                         onAdminLogin();
                         return;
                    }
                }

                if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(code)) {
                    setError('只能包含中文、英文、數字或底線');
                    return;
                }
                
                // 儲存這次的代碼
                localStorage.setItem('last_active_classroom', code);
                onLogin(code);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-slate-100 p-4 select-none">
                    <div className="bg-slate-800 p-8 rounded-xl pixel-border border-4 border-gray-700 w-full max-w-md text-center shadow-2xl">
                        <div className="flex justify-center mb-6"><div className="p-4 bg-yellow-400 rounded-full border-4 border-yellow-600 shadow-lg"><Icon name="layout-grid" size={48} className="text-yellow-900" /></div></div>
                        <h1 className="text-3xl font-black tracking-widest text-white mb-2">座位編排系統</h1>
                        <p className="text-gray-400 mb-8 text-sm">請輸入代碼以建立或進入 (可做為班級或考場ID)</p>
                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                            <div className="relative">
                                <Icon name="key" size={20} className="absolute left-3 top-3 text-gray-500" />
                                <input type="text" value={input} onChange={(e) => {setInput(e.target.value); setError('');}} placeholder="例如：Class302" className="w-full bg-slate-700 border-2 border-slate-600 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:bg-slate-600 transition-colors text-lg font-bold select-text" autoFocus />
                            </div>
                            {error && <p className="text-red-400 text-sm font-bold animate-pulse">{error}</p>}
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 mt-2"><Icon name="log-in" size={20} /> 進入編輯</button>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle');
            const [config, setConfig] = useState({ rows: 5, cols: 7, systemTitle: '未命名', defaultClass: '' });
            const [rosterText, setRosterText] = useState(DEFAULT_ROSTER);
            const [rosterMap, setRosterMap] = useState({});
            const [availableClasses, setAvailableClasses] = useState([]);
            const [seats, setSeats] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [activeClassroom, setActiveClassroom] = useState(null);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [seatMode, setSeatMode] = useState('single'); // 'single' | 'mixed'
            const [previewData, setPreviewData] = useState(null); // 儲存預覽圖片 DataURL
            const inputRefs = useRef({});

            const [helperClassName, setHelperClassName] = useState('');
            const [helperStudentList, setHelperStudentList] = useState('');
            const exportRef = useRef(null);
            const [isExporting, setIsExporting] = useState(false);

            const duplicateNumbers = useMemo(() => {
                const counts = {};
                Object.values(seats).forEach(s => { if (s.number) counts[s.number] = (counts[s.number] || 0) + 1; });
                return new Set(Object.keys(counts).filter(n => counts[n] > 1));
            }, [seats]);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed", err);
                        setSyncStatus('error');
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!activeClassroom) return;
                
                setDataLoaded(false);

                const loadLocal = () => {
                    const savedLocal = localStorage.getItem(`examMonitorData_${activeClassroom}`);
                    if (savedLocal) {
                        try {
                            const parsed = JSON.parse(savedLocal);
                            if (parsed.config) setConfig(prev => ({...prev, ...parsed.config}));
                            if (parsed.rosterText) setRosterText(parsed.rosterText);
                            if (parsed.seats) setSeats(parsed.seats);
                            if (parsed.seatMode) setSeatMode(parsed.seatMode);
                        } catch(e) {}
                    }
                    setDataLoaded(true);
                };

                if (!isFirebaseConfigured || !user) {
                    loadLocal();
                    return;
                }

                setSyncStatus('loading');
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', activeClassroom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.config) setConfig(prev => ({...prev, ...data.config}));
                        if (data.rosterText) setRosterText(data.rosterText);
                        if (data.seats) setSeats(data.seats);
                        if (data.seatMode) setSeatMode(data.seatMode);
                        setSyncStatus('idle');
                    } else {
                        const savedLocal = localStorage.getItem(`examMonitorData_${activeClassroom}`);
                        if (savedLocal) {
                            try {
                                const parsed = JSON.parse(savedLocal);
                                setConfig(prev => ({...prev, ...(parsed.config || {})}));
                                setRosterText(prev => parsed.rosterText || prev);
                                setSeats(prev => parsed.seats || prev);
                                if (parsed.seatMode) setSeatMode(parsed.seatMode);
                            } catch(e){}
                        }
                        setSyncStatus('idle');
                    }
                    setDataLoaded(true);
                }, (error) => { 
                    console.error("Sync error", error); 
                    setSyncStatus('error');
                    loadLocal();
                });
                return () => unsubscribe();
            }, [user, activeClassroom]);

            useEffect(() => {
                if (!activeClassroom || !dataLoaded) return; 

                const timer = setTimeout(() => {
                    const dataToSave = { config, rosterText, seats, seatMode };
                    localStorage.setItem(`examMonitorData_${activeClassroom}`, JSON.stringify(dataToSave));
                }, 1000); 

                return () => clearTimeout(timer);
            }, [activeClassroom, config, rosterText, seats, seatMode, dataLoaded]);

            // 名單解析邏輯 (保持不變)
            useEffect(() => {
                const lines = rosterText.split('\n');
                const newMap = {};
                const foundClasses = new Set();
                let currentClass = null;

                lines.forEach((line) => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;

                    const classMatch = trimmedLine.match(/^\[(.*)\]$/);
                    if (classMatch) {
                        currentClass = classMatch[1].trim();
                        foundClasses.add(currentClass);
                        return;
                    }

                    const parts = trimmedLine.split(/[\t,，\s]+/);
                    if (parts.length === 1 && !/^\d+$/.test(parts[0])) {
                        currentClass = parts[0];
                        foundClasses.add(currentClass);
                        return;
                    }

                    if (parts.length >= 2) {
                        const seatPart = parts[0]; 
                        const namePart = parts[1]; 
                        
                        let uniqueId = seatPart;
                        let className = null;

                        const isPureNumber = /^\d+$/.test(seatPart);
                        
                        if (currentClass && isPureNumber) {
                            uniqueId = `${currentClass}-${seatPart}`;
                            className = currentClass;
                        } else if (seatPart.includes('-')) {
                            const splitId = seatPart.split('-');
                            className = splitId[0];
                        } else if (currentClass) {
                             uniqueId = `${currentClass}-${seatPart}`;
                             className = currentClass;
                        }

                        newMap[uniqueId] = {
                            name: namePart,
                            className: className
                        };
                    }
                });
                setRosterMap(newMap);
                setAvailableClasses(Array.from(foundClasses).sort());
            }, [rosterText]);


            const saveToCloud = async () => {
                if (!activeClassroom) return;
                localStorage.setItem(`examMonitorData_${activeClassroom}`, JSON.stringify({ config, rosterText, seats, seatMode }));
                
                if (!isFirebaseConfigured || !user) { alert('已儲存至本地 (未設定 Firebase)'); return; }
                setSyncStatus('saving');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', activeClassroom);
                    await setDoc(docRef, { config, rosterText, seats, seatMode, lastUpdated: new Date().toISOString(), updatedBy: user.uid });
                    setSyncStatus('saved');
                    setTimeout(() => setSyncStatus('idle'), 2000);
                } catch (e) { console.error("Save failed:", e); setSyncStatus('error'); alert(`雲端儲存失敗: ${e.message}\n請檢查 Firebase 規則`); }
            };

            const deleteClassroomData = async () => {
                if (!activeClassroom) return;
                const confirmCode = prompt(`警告：這將會永久刪除「${activeClassroom}」的所有資料！\n\n請輸入「${activeClassroom}」以確認：`);
                if (confirmCode === activeClassroom) {
                    try {
                        setSyncStatus('saving');
                        if (isFirebaseConfigured && user) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', activeClassroom));
                        }
                        localStorage.removeItem(`examMonitorData_${activeClassroom}`);
                        alert('資料已刪除。');
                        setSeats({}); setRosterText(DEFAULT_ROSTER); setActiveClassroom(null);
                    } catch (e) { console.error(e); alert('刪除失敗'); setSyncStatus('error'); }
                }
            };

            const handleClearSeats = () => {
                if (confirm('確定要清空所有座位安排嗎？\n\n此動作將移除所有格子內的座號與班級設定，以便重新安排。')) {
                    setSeats({});
                }
            };

            const updateSeatNumber = (r, c, type, value) => {
                const key = `${r}-${c}`;
                const currentSeat = seats[key] || { number: '', status: 'empty' };
                const currentVal = currentSeat.number || '';
                
                let [currentClass, currentNum] = currentVal.includes('-') 
                    ? currentVal.split('-') 
                    : ['', currentVal];
                
                // 單一班級模式下，不處理班級前綴 (顯示上)，但資料結構為了統一，我們暫時保留既有邏輯
                // 只是輸入時，若為單一班級模式，Class 部分會是空的或依賴全域設定（但這裡我們讓它保持為空，顯示時處理）
                if (seatMode === 'single') {
                    // 單一班級模式：只更新座號部分，班級部分視為空（或忽略）
                    if (type === 'seat') {
                        // 直接存座號
                        setSeats(prev => ({ ...prev, [key]: { number: value } }));
                    }
                    // 單一模式沒有 class input
                } else {
                    // 混合模式：保留原有邏輯
                    if (!currentVal.includes('-')) {
                        currentNum = currentVal;
                        currentClass = '';
                    }

                    let newClass = currentClass;
                    let newNum = currentNum;

                    if (type === 'class') newClass = value; 
                    if (type === 'seat') {
                        newNum = value; 
                        if (!newClass && config.defaultClass && newNum.trim()) {
                            newClass = config.defaultClass;
                        }
                    }

                    let newVal = '';
                    if (newClass && !newNum) newVal = `${newClass}-`;
                    else if (!newClass && newNum) newVal = newNum;
                    else if (newClass && newNum) newVal = `${newClass}-${newNum}`;
                    else newVal = '';
                    
                    setSeats(prev => ({ ...prev, [key]: { number: newVal } }));
                }
            };

            const handleKeyDown = (e, r, c, type) => {
                let targetR = r; let targetC = c;
                if (e.key === 'Enter') {
                    if (type === 'class') {
                        const targetKey = `${r}-${c}-seat`;
                        if (inputRefs.current[targetKey]) { 
                            e.preventDefault(); 
                            inputRefs.current[targetKey].focus(); 
                        }
                        return;
                    }
                }

                if (e.key === 'ArrowUp') targetR = Math.max(0, r - 1);
                else if (e.key === 'ArrowDown') targetR = Math.min(config.rows - 1, r + 1);
                else if (e.key === 'ArrowLeft') targetC = Math.max(0, c - 1);
                else if (e.key === 'ArrowRight') targetC = Math.min(config.cols - 1, c + 1);
                else return;
                
                // 單一模式下沒有 class input，所以只需導向 seat input
                const targetKey = `${targetR}-${targetC}-seat`; 
                if (inputRefs.current[targetKey]) { 
                    e.preventDefault(); 
                    inputRefs.current[targetKey].focus(); 
                }
            };

            const handleAddClassToRoster = () => {
                if (!helperStudentList.trim()) return;
                let newText = rosterText.trim();
                if (newText) newText += '\n\n';
                if (helperClassName.trim()) { newText += `[${helperClassName.trim()}]\n`; }
                newText += helperStudentList.trim();
                setRosterText(newText);
                setHelperClassName('');
                setHelperStudentList('');
            };

            const isClassValid = !config.defaultClass || availableClasses.includes(config.defaultClass.trim());

            // ====================================================================
            // ▼ 匯出與預覽邏輯 ▼
            // ====================================================================
            const generatePdfContent = () => {
                const pdfContainer = document.getElementById('pdf-export-container');
                if (!pdfContainer) return;

                pdfContainer.innerHTML = '';
                
                // 標題
                const title = document.createElement('h1');
                title.style.cssText = 'font-size: 36pt; font-weight: 900; margin-bottom: 20px; color: #000; text-align: center;';
                title.textContent = config.systemTitle || (seatMode === 'single' ? '班級座位表' : '考場座位表');
                pdfContainer.appendChild(title);

                // 講台
                const podium = document.createElement('div');
                podium.style.cssText = `
                    width: 100%; height: 20mm; background-color: #f1f5f9; border: 2px solid #64748b;
                    border-radius: 8px; display: flex; justify-content: center; align-items: center;
                    font-size: 18pt; font-weight: 700; color: #334155; margin-bottom: 20px;
                `;
                podium.textContent = '講台 / 講師區 (Podium)';
                pdfContainer.appendChild(podium);

                const tableWrapper = document.createElement('div');
                tableWrapper.style.cssText = `flex-grow: 1; display: flex; flex-direction: column; justify-content: center; width: 100%;`;
                
                const table = document.createElement('table');
                table.className = 'export-table';
                const tbody = document.createElement('tbody');
                
                for (let r = 0; r < config.rows; r++) {
                    const tr = document.createElement('tr');
                    for (let c = 0; c < config.cols; c++) {
                        const td = document.createElement('td');
                        td.className = 'export-cell';
                        const minHeight = Math.floor(220 / config.rows); 
                        td.style.height = `${minHeight}mm`;

                        const key = `${r}-${c}`;
                        const seat = seats[key] || { number: '' };
                        
                        // 資料處理：依據模式決定如何顯示
                        let displayNum = '';
                        let displayClass = '';
                        let displayStudentName = '';

                        // 解析座號
                        const [classPart, seatPart] = seat.number.includes('-') 
                            ? seat.number.split('-') 
                            : ['', seat.number];

                        if (seatMode === 'single') {
                            // 單一班級：只顯示座號部分 (若有 - 則取後段，若無則全取)
                            displayNum = seatPart || seat.number; // fallback
                            // 嘗試從名單找對應
                            // 單一模式下，名單匹配可能比較模糊，這裡假設使用者輸入的是純座號，且名單有對應格式
                            // 我們嘗試直接用 seat.number 找，或加上 Class Name 找 (比較複雜，暫時直接用座號找)
                            // 為了簡單，單一模式下若名單中有 [班級] 區塊，可能對應不到。
                            // 但為了匯出，我們盡力顯示。
                            const studentData = rosterMap[seat.number] || rosterMap[`${config.systemTitle}-${seat.number}`];
                            displayStudentName = studentData?.name || '';
                        } else {
                            // 混合模式：顯示班級與座號
                            displayClass = classPart;
                            displayNum = seatPart || seat.number;
                            const studentData = rosterMap[seat.number];
                            displayStudentName = studentData?.name || '';
                        }
                        
                        // 1. 班級標籤 (僅混合模式)
                        if (seatMode === 'mixed' && displayClass.trim()) {
                            const classDiv = document.createElement('div');
                            classDiv.textContent = displayClass;
                            const color = getClassColor(displayClass).replace('bg-', '');
                            const colorMap = {
                                'blue-600': '#2563eb', 'emerald-600': '#059669', 'violet-600': '#7c3aed',
                                'orange-600': '#ea580c', 'pink-600': '#db2777', 'cyan-600': '#0891b2',
                                'fuchsia-600': '#c026d3', 'lime-700': '#4d7c0f', 'sky-600': '#0284c7', 'indigo-600': '#4f46e5'
                            };
                            const bgColor = colorMap[color] || '#4b5563';
                            classDiv.style.cssText = `
                                position: absolute; top: 6px; left: 6px; background-color: ${bgColor};
                                color: white; font-size: 10pt; font-weight: bold; padding: 2px 8px; border-radius: 4px;
                            `;
                            td.appendChild(classDiv);
                        }

                        // 2. 座號
                        const numberDiv = document.createElement('div');
                        numberDiv.style.cssText = `font-size: 36pt; font-weight: 900; color: #1e293b; line-height: 1; margin-bottom: 8px;`;
                        numberDiv.textContent = displayNum.trim() || '-';
                        td.appendChild(numberDiv);

                        // 3. 姓名
                        const nameDiv = document.createElement('div');
                        nameDiv.style.cssText = `font-size: 18pt; font-weight: 700; color: #334155;`;
                        nameDiv.textContent = displayStudentName || '';
                        td.appendChild(nameDiv);

                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }
                table.appendChild(tbody);
                tableWrapper.appendChild(table);
                pdfContainer.appendChild(tableWrapper);

                exportRef.current = pdfContainer;
            };

            const handlePreview = async () => {
                setIsExporting(true);
                generatePdfContent();
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    const canvas = await html2canvas(exportRef.current, {
                        scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff', windowWidth: 2480,
                    });
                    const imgData = canvas.toDataURL('image/png');
                    setPreviewData(imgData); // 設定預覽資料，開啟 Modal
                } catch (error) {
                    console.error('預覽失敗:', error);
                    alert('預覽生成失敗。');
                } finally {
                    setIsExporting(false);
                }
            };

            const downloadPdf = () => {
                if (!previewData) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(previewData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                const yPos = (pdfHeight - imgHeight) / 2;
                pdf.addImage(previewData, 'PNG', 0, Math.max(0, yPos), pdfWidth, imgHeight);
                pdf.save(`${config.systemTitle || '座位表'}.pdf`);
                setPreviewData(null);
            };

            const downloadImage = () => {
                if (!previewData) return;
                const a = document.createElement('a');
                a.href = previewData;
                a.download = `${config.systemTitle || '座位表'}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setPreviewData(null);
            };
            // ====================================================================

            if (isAdminMode) return <AdminPanel onBack={() => setIsAdminMode(false)} onEnterClass={(id) => { setIsAdminMode(false); setActiveClassroom(id); }} />;
            if (!activeClassroom) return <LoginScreen onLogin={setActiveClassroom} onAdminLogin={() => setIsAdminMode(true)} />;

            return (
                <div className="h-screen w-screen flex flex-col bg-slate-900 text-slate-100 overflow-hidden font-mono select-none">
                    {/* Navbar */}
                    <div className="shrink-0 w-full bg-gray-300 text-gray-800 p-2 flex justify-between items-center border-b-4 border-gray-400 shadow-lg z-20 relative">
                        <div className="flex items-center gap-4">
                            {/* 模式切換開關 */}
                            <div className="bg-white rounded-lg p-1 flex shadow-inner border border-gray-300 ml-2">
                                <button 
                                    onClick={() => setSeatMode('single')}
                                    className={`px-3 py-1 rounded text-xs font-bold transition-all flex items-center gap-1 ${seatMode === 'single' ? 'bg-blue-600 text-white shadow' : 'text-gray-500 hover:bg-gray-100'}`}
                                >
                                    <Icon name="user" size={14}/> 單一班級
                                </button>
                                <button 
                                    onClick={() => setSeatMode('mixed')}
                                    className={`px-3 py-1 rounded text-xs font-bold transition-all flex items-center gap-1 ${seatMode === 'mixed' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-gray-100'}`}
                                >
                                    <Icon name="users" size={14}/> 混合班級
                                </button>
                            </div>

                            <input 
                                type="text" 
                                className="font-black text-xl tracking-widest text-gray-700 bg-transparent border-b-2 border-gray-500 outline-none hidden md:block placeholder-gray-400 w-64 select-text" 
                                value={config.systemTitle || ''} 
                                placeholder={seatMode === 'single' ? "請輸入班級名稱 (例如: 高一仁)" : "請輸入考場名稱 (例如: 第01試場)"} 
                                onChange={(e) => setConfig({...config, systemTitle: e.target.value})} 
                            />
                            
                            {/* 僅在混合模式顯示預設班級 */}
                            {seatMode === 'mixed' && (
                                <div className="hidden md:flex items-center gap-2 ml-2 border-l pl-4 border-gray-400 relative">
                                    <span className="text-xs font-bold text-gray-500">預設班級:</span>
                                    <div className="relative">
                                        <input 
                                            list="class-options"
                                            type="text" 
                                            className={`w-24 bg-white border-2 rounded px-2 py-1 text-sm font-bold placeholder-gray-300 focus:outline-none transition-colors ${!isClassValid ? 'border-red-500 text-red-600 focus:border-red-600' : 'border-gray-300 text-blue-600 focus:border-blue-500'}`} 
                                            placeholder="例如:301" 
                                            value={config.defaultClass || ''} 
                                            onChange={(e) => setConfig({...config, defaultClass: e.target.value})} 
                                        />
                                        {!isClassValid && (
                                            <div className="absolute top-full left-0 mt-1 bg-red-500 text-white text-[10px] px-1 rounded whitespace-nowrap z-50 shadow-lg animate-bounce">
                                                ⚠️ 名單無此班級
                                            </div>
                                        )}
                                    </div>
                                    <datalist id="class-options">
                                        {availableClasses.map(c => <option key={c} value={c} />)}
                                    </datalist>
                                </div>
                            )}

                            <button onClick={saveToCloud} disabled={syncStatus === 'saving'} className={`flex items-center gap-2 px-3 py-1 rounded-full border-inner shadow-inner transition-colors ${syncStatus === 'saved' ? 'bg-green-100' : 'bg-gray-200 hover:bg-gray-300'} ml-2`} title="手動儲存">
                                {syncStatus === 'loading' ? <Icon name="refresh-cw" className="animate-spin text-blue-500" size={14} /> : syncStatus === 'saving' ? <Icon name="cloud-upload" className="animate-bounce text-blue-500" size={14} /> : syncStatus === 'saved' ? <Icon name="check" className="text-green-600" size={14} /> : syncStatus === 'error' ? <Icon name="cloud-off" className="text-red-500" size={14} /> : <Icon name="save" className="text-gray-600" size={14} />}
                                <span className={`text-xs font-bold ${syncStatus === 'saved' ? 'text-green-700' : 'text-gray-600'}`}>{syncStatus === 'loading' ? '讀取...' : syncStatus === 'saving' ? '儲存中...' : syncStatus === 'saved' ? '已儲存' : syncStatus === 'error' ? '失敗' : '點此存檔'}</span>
                            </button>

                            <button onClick={handleClearSeats} className="flex items-center gap-2 px-3 py-1 rounded-full border-inner shadow-inner transition-colors bg-red-100 hover:bg-red-200 ml-2" title="清空所有座位">
                                <Icon name="trash-2" className="text-red-600" size={14} />
                                <span className="text-xs font-bold text-red-700">清空</span>
                            </button>
                        </div>
                        <div className="flex gap-2">
                            {/* 匯出預覽按鈕 */}
                            <button 
                                onClick={handlePreview} 
                                disabled={isExporting}
                                className="px-4 py-1.5 rounded-lg font-bold flex items-center gap-2 text-sm transition-all bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 disabled:bg-gray-400 border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1"
                            >
                                {isExporting ? <Icon name="loader-2" className="animate-spin" size={16} /> : <Icon name="eye" size={16} />} 預覽與匯出
                            </button>
                            
                            <button onClick={() => setShowSettings(true)} className="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg border-b-4 border-gray-400 hover:bg-white active:border-b-0 active:translate-y-1 flex items-center gap-1 text-sm"><Icon name="settings" size={16} /> 設定</button>
                            <button onClick={() => setActiveClassroom(null)} className="px-3 py-1.5 bg-red-500 text-white rounded-lg font-bold border-b-4 border-red-700 hover:bg-red-400 active:border-b-0 active:translate-y-1 text-sm flex items-center" title="登出"><Icon name="log-out" size={16} /></button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex w-full overflow-hidden relative p-4 gap-4">
                        
                        {/* Left Section: Seat Grid */}
                        <div className="flex-1 bg-slate-800 rounded-xl p-2 md:p-4 pixel-border relative flex flex-col border-4 border-gray-700 overflow-hidden">
                            {/* Podium */}
                            <div className="w-full h-12 bg-amber-700 text-amber-100 rounded-lg border-b-4 border-amber-900 shadow-lg flex items-center justify-center relative overflow-hidden group mb-4 shrink-0">
                                <Icon name="monitor" size={32} />
                                <span className="ml-4 font-bold text-xl">講台 / 講師區 (Podium)</span>
                            </div>

                            {/* Seat Grid */}
                            <div className="flex-1 w-full h-full pb-2 overflow-y-auto no-scrollbar">
                                <div className="grid gap-2 h-full w-full" style={{ gridTemplateColumns: `repeat(${config.cols}, 1fr)` }}>
                                    {Array.from({ length: config.rows }).map((_, r) => (
                                        Array.from({ length: config.cols }).map((_, c) => {
                                            const key = `${r}-${c}`;
                                            const seat = seats[key] || { number: '' };
                                            const studentData = rosterMap[seat.number];
                                            const studentName = studentData?.name || '';
                                            
                                            const isDuplicate = seat.number && duplicateNumbers.has(seat.number);

                                            // 資料解析
                                            const [editClass, editSeat] = seat.number.includes('-') 
                                                ? seat.number.split('-') 
                                                : ['', seat.number];

                                            const isCellClassValid = !editClass || availableClasses.includes(editClass.trim());

                                            let containerClasses = "relative w-full h-full p-1 rounded border-b-4 transition-all flex flex-col items-center justify-center shadow-lg select-none ";

                                            if (seatMode === 'mixed' && !isCellClassValid && editClass) {
                                                containerClasses += "bg-orange-500 border-orange-700 text-white"; 
                                            } else if (isDuplicate) {
                                                containerClasses += "bg-red-100 border-red-500 text-red-900 ring-2 ring-red-500";
                                            } else if (seat.number) {
                                                containerClasses += "bg-slate-100 border-slate-300 text-slate-900 hover:bg-white cursor-pointer";
                                            } else {
                                                containerClasses += "bg-slate-700 border-slate-900 opacity-30";
                                            }

                                            return (
                                                <div key={key} className={containerClasses}>
                                                    <div className="flex flex-col w-full items-center justify-center gap-1">
                                                        {/* 僅在混合模式顯示班級輸入 */}
                                                        {seatMode === 'mixed' && (
                                                            <input 
                                                                type="text"
                                                                placeholder={config.defaultClass || "班級"}
                                                                className={`w-full text-center bg-transparent outline-none text-xs md:text-sm font-bold p-0 placeholder-gray-500 transition-colors ${!isCellClassValid ? 'text-white font-black placeholder-white/50' : (editClass ? 'text-blue-400' : 'text-gray-500')}`}
                                                                value={editClass}
                                                                onChange={(e) => updateSeatNumber(r, c, 'class', e.target.value)}
                                                                onKeyDown={(e) => handleKeyDown(e, r, c, 'class')}
                                                                title={!isCellClassValid ? "⚠️ 名單無此班級" : ""}
                                                            />
                                                        )}
                                                        
                                                        <input 
                                                            ref={el => inputRefs.current[`${key}-seat`] = el} 
                                                            type="text"
                                                            placeholder="座號"
                                                            className={`w-full text-center bg-transparent outline-none font-bold text-2xl md:text-4xl border-b border-gray-400/50 focus:border-blue-500 p-0 select-text ${!isCellClassValid && seatMode === 'mixed' ? 'text-white border-white/50' : (isDuplicate ? 'text-red-600 border-red-400' : (seat.number ? 'text-slate-900' : 'text-white'))}`} 
                                                            // 單一模式只顯示座號部分，混合模式顯示座號部分(editSeat)
                                                            value={seatMode === 'single' ? (editSeat || seat.number) : editSeat} 
                                                            onChange={(e) => updateSeatNumber(r, c, 'seat', e.target.value)} 
                                                            onKeyDown={(e) => handleKeyDown(e, r, c, 'seat')} 
                                                        />
                                                    </div>
                                                    
                                                    {/* 僅在混合模式顯示班級標籤 */}
                                                    {seatMode === 'mixed' && editClass && (
                                                        <div className={`absolute top-1 left-1 class-badge ${getClassColor(editClass)} text-white`}>
                                                            {editClass}
                                                        </div>
                                                    )}

                                                    {seat.number && (
                                                        <div className={`text-sm md:text-xl font-bold truncate w-full text-center px-0.5 leading-tight mt-1 ${(!isCellClassValid && seatMode === 'mixed') ? 'text-white' : (isDuplicate ? 'text-red-600' : 'text-slate-600')}`}>{studentName || ''}</div>
                                                    )}
                                                    
                                                    {isDuplicate && <div className="absolute top-1 right-1 bg-yellow-400 text-red-900 text-[10px] font-bold px-1 rounded shadow z-10 animate-pulse">重複!</div>}
                                                </div>
                                            );
                                        })
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Right Section: Roster Management */}
                        <div className="w-96 flex flex-col gap-4 shrink-0 h-full">
                            <div className="bg-amber-50 rounded-xl flex-1 p-4 pixel-border flex flex-col text-slate-800 overflow-hidden border-4 border-gray-700">
                                <h3 className="font-bold text-xl border-b-4 border-amber-200 pb-2 mb-3 flex items-center gap-2 text-amber-800 shrink-0"><Icon name="users" size={24} /> 班級名單與學生資訊</h3>
                                <p className="text-sm text-gray-500 mb-2">已解析班級: {availableClasses.join(', ') || '無'}</p>
                                <div className="flex-1 overflow-y-auto no-scrollbar pr-2">
                                    <pre className="text-xs font-mono bg-white p-2 rounded border border-gray-300 whitespace-pre-wrap">{rosterText || '請在設定中輸入名單'}</pre>
                                </div>
                                <div className="shrink-0 mt-4 pt-2 border-t border-gray-300">
                                    <button onClick={() => setShowSettings(true)} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                                        <Icon name="edit" size={16} /> 編輯名單與考場大小
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 預覽 Modal */}
                    {previewData && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-white rounded-lg shadow-2xl p-4 w-full max-w-4xl h-full max-h-[90vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <Icon name="eye" className="text-blue-600" /> 匯出預覽 (A4)
                                    </h2>
                                    <button onClick={() => setPreviewData(null)} className="text-gray-500 hover:text-red-500 transition-colors">
                                        <Icon name="x" size={24} />
                                    </button>
                                </div>
                                
                                <div className="flex-1 bg-gray-100 overflow-auto rounded border border-gray-300 flex items-center justify-center p-4">
                                    <img src={previewData} className="shadow-lg max-w-full h-auto object-contain border bg-white" alt="預覽圖" />
                                </div>

                                <div className="mt-4 flex justify-end gap-3 pt-2 border-t">
                                    <button onClick={() => setPreviewData(null)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-bold">取消</button>
                                    <button onClick={downloadImage} className="px-4 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 flex items-center gap-2 shadow">
                                        <Icon name="image" size={18} /> 下載圖片 (PNG)
                                    </button>
                                    <button onClick={downloadPdf} className="px-4 py-2 bg-red-600 text-white rounded font-bold hover:bg-red-700 flex items-center gap-2 shadow">
                                        <Icon name="file-text" size={18} /> 下載 PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icon name="settings" className="text-gray-600" /> 考場與資料庫設定</h2><button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-gray-800">✕</button></div>
                                <div className="overflow-y-auto flex-1 space-y-6 pr-2">
                                    <section className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icon name="cloud" className="text-blue-600" /> 雲端資料同步 (Firebase)</h3>
                                        {isFirebaseConfigured ? (
                                            <>
                                                <p className="text-sm text-blue-600 mb-3">資料將自動儲存在您的 Firebase 帳號下。</p>
                                                <button onClick={saveToCloud} disabled={syncStatus === 'saving'} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2 hover:bg-blue-700 disabled:opacity-50"><Icon name="cloud-upload" size={18} />{syncStatus === 'saving' ? '儲存中...' : '手動儲存目前設定'}</button>
                                            </>
                                        ) : (
                                            <p className="text-sm text-red-600">尚未設定 Firebase Config。</p>
                                        )}
                                    </section>
                                    <section className="bg-gray-50 p-4 rounded-lg">
                                        <h3 className="font-bold text-gray-700 mb-2">A. 座位排列</h3>
                                        <div className="flex gap-4">
                                            <div className="flex flex-col gap-1">
                                                <label className="text-sm text-gray-500">列數</label>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => setConfig({...config, rows: Math.max(1, config.rows - 1)})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="minus" size={18}/></button>
                                                    <input type="number" className="w-16 text-center border rounded p-1 text-black font-bold" value={config.rows} onChange={(e) => setConfig({...config, rows: parseInt(e.target.value) || 1})} />
                                                    <button onClick={() => setConfig({...config, rows: config.rows + 1})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="plus" size={18}/></button>
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-sm text-gray-500">行數</label>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => setConfig({...config, cols: Math.max(1, config.cols - 1)})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="minus" size={18}/></button>
                                                    <input type="number" className="w-16 text-center border rounded p-1 text-black font-bold" value={config.cols} onChange={(e) => setConfig({...config, cols: parseInt(e.target.value) || 1})} />
                                                    <button onClick={() => setConfig({...config, cols: config.cols + 1})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="plus" size={18}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                    
                                    <section>
                                        <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-2">B. 班級名單</h3>
                                        <div className="mb-2 space-y-4">
                                            <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-3">
                                                <label className="font-bold text-indigo-800 mb-2 block flex items-center gap-2">
                                                    <Icon name="wand-2" size={16} /> 快速新增班級 (Class Generator)
                                                </label>
                                                <div className="flex gap-2 mb-2">
                                                    <div className="flex-1">
                                                        <input 
                                                            type="text" 
                                                            className="w-full border border-indigo-200 rounded px-3 py-2 text-sm text-black placeholder-gray-400 focus:outline-none focus:border-indigo-500"
                                                            placeholder="班級名稱 (例如: 301, 高一仁...)" 
                                                            value={helperClassName}
                                                            onChange={(e) => setHelperClassName(e.target.value)}
                                                        />
                                                    </div>
                                                </div>
                                                <textarea 
                                                    className="w-full h-24 p-3 border border-indigo-200 rounded font-mono text-sm bg-white focus:outline-none focus:border-indigo-500 text-gray-800 mb-2 placeholder-gray-400" 
                                                    placeholder="在此貼上該班的座號與姓名..." 
                                                    value={helperStudentList} 
                                                    onChange={(e) => setHelperStudentList(e.target.value)} 
                                                />
                                                <button 
                                                    onClick={handleAddClassToRoster}
                                                    disabled={!helperStudentList.trim()}
                                                    className="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-sm transition-all"
                                                >
                                                    <Icon name="plus-circle" size={16} /> 加入到下方總名單
                                                </button>
                                            </div>

                                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                                <label className="text-sm font-bold text-gray-600 block mb-1">完整名單內容 (格式: [班級]\n座號\t姓名)</label>
                                                <textarea 
                                                    className="w-full h-32 p-3 border rounded font-mono text-sm bg-white focus:ring-2 focus:ring-green-500 outline-none text-gray-800 select-text" 
                                                    placeholder="[班級名稱] (換行) [座號] [姓名]..." 
                                                    value={rosterText} 
                                                    onChange={(e) => setRosterText(e.target.value)} 
                                                />
                                            </div>
                                        </div>
                                    </section>
                                    
                                    <section className="bg-red-50 p-4 rounded-lg border border-red-200 mt-4">
                                        <h3 className="font-bold text-red-800 mb-2 flex items-center gap-2"><Icon name="shield-alert" className="text-red-600" /> 管理員專區</h3>
                                        <p className="text-sm text-red-700 mb-3">此操作將永久刪除當前考場「{activeClassroom}」的所有資料。</p>
                                        <button onClick={deleteClassroomData} className="w-full bg-red-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2 hover:bg-red-700 font-bold"><Icon name="trash-2" size={18} /> 刪除此考場資料</button>
                                    </section>
                                </div>
                                <div className="mt-6 flex justify-between items-center pt-4 border-t"><span className="text-xs text-gray-400">{user ? `ID: ${user.uid.slice(0,8)}...` : '本地模式'}</span><button onClick={() => {saveToCloud(); setShowSettings(false);}} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg">儲存並關閉</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
