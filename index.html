<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº§ä½ç·¨æ’å°ˆç”¨ç³»çµ±</title>
    
    <!-- è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ React å’Œ Babel (æ ¸å¿ƒé‹ç®—) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è¼‰å…¥ Lucide Icons (åœ–ç¤º) -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <!-- åŒ¯å‡º PDF/åœ–ç‰‡æ‰€éœ€å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- è‡ªå®šç¾©æ¨£å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', monospace; }
        .pixel-border {
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.3);
        }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™æ²å‹•åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* éš±è— number input çš„ä¸Šä¸‹ç®­é ­ */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* ç­ç´šæ¨™ç±¤æ¨£å¼ */
        .class-badge {
            font-size: 1.7rem; 
            line-height: 1.2;
            padding: 6px 8px;   
            border-radius: 6px;
            font-weight: 900;
            letter-spacing: 0.05em;
            box-shadow: 2px 2px 3px rgba(0,0,0,0.2);
            text-shadow: 0px 1px 2px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* éš±è—çš„ PDF åŒ¯å‡ºå®¹å™¨æ¨£å¼ */
        #pdf-export-container {
            width: 210mm; /* A4 å¯¬åº¦ */
            height: 297mm; /* A4 é«˜åº¦ */
            padding: 20mm;
            background-color: white;
            color: black;
            position: absolute; /* è®“å®ƒä¸ä½”ç”¨æ­£å¸¸é é¢ç©ºé–“ */
            top: -5000px; /* ç§»åˆ°è¦–çª—å¤– */
            left: -5000px;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .pdf-grid-item {
            /* PDF è¼¸å‡ºæ™‚çš„åº§ä½æ ¼æ¨£å¼ */
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            border-radius: 4px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 10pt;
            box-sizing: border-box;
            padding: 5px;
            position: relative;
            aspect-ratio: 1 / 1; /* ä¿æŒåº§ä½æ–¹æ ¼ç‚ºæ­£æ–¹å½¢ */
        }
        .pdf-grid-item-number {
            font-size: 20pt;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 2px;
        }
        .pdf-grid-item-class {
            font-size: 8pt;
            font-weight: 700;
            position: absolute;
            top: 2px;
            left: 2px;
            padding: 1px 3px;
            border-radius: 2px;
            color: white;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>
    <!-- PDF åŒ¯å‡ºç”¨çš„éš±è—å®¹å™¨ -->
    <div id="pdf-export-container"></div>

    <!-- ä¸»ç¨‹å¼é‚è¼¯ -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ==========================================
        // â–¼ æ‚¨çš„ Firebase Config â–¼
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBd1OUQ2wwEOSIezzhsuuYcjZSXJPn-WnI",
          authDomain: "examseat-508e9.firebaseapp.com",
          projectId: "examseat-508e9",
          storageBucket: "examseat-508e9.firebasestorage.app",
          messagingSenderId: "959964513566",
          appId: "1:959964513566:web:88dac9c40c5993a90a750f"
        };
        // ==========================================

        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.projectId;
        let app, auth, db;
        if (isFirebaseConfigured) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }
        const appId = "examseat-508e9";

        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                // ç¢ºä¿ Lucide Icons è¢«æ­£ç¢ºæ¸²æŸ“
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Constants ---
        const ADMIN_HASH = "667d3b4405324cb53a755b5eb6c0d5370322527a32f75964d9a040230d273033";

        // ç­ç´šé¡è‰²æ± 
        const CLASS_COLORS = [
            'bg-blue-600', 'bg-emerald-600', 'bg-violet-600', 
            'bg-orange-600', 'bg-pink-600', 'bg-cyan-600', 
            'bg-fuchsia-600', 'bg-lime-700', 'bg-sky-600', 'bg-indigo-600'
        ];

        const DEFAULT_ROSTER = `[é«˜ä¸€OO]
1\tç‹OO
2\tæ—OO
[é«˜ä¸€XX]
1\tæ—OO
2\tæ—OO`;
        
        // --- Helpers ---
        const getClassColor = (className) => {
            if (!className) return 'bg-slate-800';
            let hash = 0;
            for (let i = 0; i < className.length; i++) {
                hash = className.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % CLASS_COLORS.length;
            return CLASS_COLORS[index];
        };

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Buffer(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- Components (AdminPanel and LoginScreen remain the same for auth) ---
        // ç‚ºäº†å°ˆæ³¨æ–¼æ ¸å¿ƒï¼ŒAdminPanel å’Œ LoginScreen ç¨‹å¼ç¢¼èˆ‡åŸå§‹æª”æ¡ˆç›¸åŒï¼Œä»¥ä¿ç•™ Firebase èªè­‰å’Œç­ç´šç®¡ç†åŠŸèƒ½ã€‚

        const AdminPanel = ({ onBack, onEnterClass }) => {
            const [classList, setClassList] = useState([]);
            const [loading, setLoading] = useState(true);

            const fetchClasses = async () => {
                if (!db) return;
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'classrooms'));
                    const list = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.config) {
                             list.push({
                                id: doc.id,
                                lastUpdated: data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : 'æœªçŸ¥',
                                ...data
                            });
                        }
                    });
                    list.sort((a, b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0));
                    setClassList(list);
                } catch (error) {
                    console.error("è®€å–å¤±æ•—:", error);
                    alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æ¬Šé™è¨­å®šã€‚");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchClasses(); }, []);

            const handleDelete = async (id) => {
                if (confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ç­ç´šã€Œ${id}ã€å—ï¼Ÿ`)) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', id));
                        setClassList(prev => prev.filter(c => c.id !== id));
                    } catch (error) { alert("åˆªé™¤å¤±æ•—"); }
                }
            };

            return (
                <div className="flex flex-col items-center min-h-screen bg-slate-900 text-slate-100 p-4 font-mono">
                    <div className="w-full max-w-4xl">
                        <div className="flex justify-between items-center mb-6 bg-red-900/50 p-4 rounded-xl border-l-4 border-red-500">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-red-600 rounded-lg shadow-lg"><Icon name="shield-alert" size={32} className="text-white" /></div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-widest text-white">ADMIN DASHBOARD</h1>
                                    <p className="text-red-200 text-sm">ç³»çµ±ç®¡ç†ä»‹é¢</p>
                                </div>
                            </div>
                            <button onClick={onBack} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg flex items-center gap-2 font-bold transition-all">
                                <Icon name="log-out" size={18} /> ç™»å‡º
                            </button>
                        </div>

                        <div className="bg-slate-800 rounded-xl pixel-border border-4 border-gray-700 overflow-hidden shadow-2xl">
                            <div className="p-4 border-b-2 border-gray-700 flex justify-between items-center bg-slate-750">
                                <h2 className="font-bold text-lg flex items-center gap-2"><Icon name="list" /> ç­ç´šåˆ—è¡¨ ({classList.length})</h2>
                                <button onClick={fetchClasses} className="p-2 hover:bg-slate-600 rounded-full"><Icon name="refresh-cw" size={18} /></button>
                            </div>
                            
                            {loading ? (
                                <div className="p-8 text-center text-gray-400 flex flex-col items-center gap-2">
                                    <Icon name="loader-2" className="animate-spin" size={32} />
                                    è®€å–ä¸­...
                                </div>
                            ) : classList.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">ç„¡ç­ç´šè³‡æ–™</div>
                            ) : (
                                <div className="max-h-[70vh] overflow-y-auto no-scrollbar">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-900 text-gray-400 sticky top-0 z-10 shadow-md">
                                            <tr>
                                                <th className="p-4 font-bold">ç­ç´šä»£ç¢¼</th>
                                                <th className="p-4 font-bold hidden md:table-cell">é¡¯ç¤ºåç¨±</th>
                                                <th className="p-4 font-bold hidden sm:table-cell">æœ€å¾Œæ›´æ–°</th>
                                                <th className="p-4 font-bold text-right">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-700">
                                            {classList.map(cls => (
                                                <tr key={cls.id} className="hover:bg-slate-700/50 transition-colors">
                                                    <td className="p-4 font-bold text-yellow-400 font-mono text-lg">{cls.id}</td>
                                                    <td className="p-4 text-gray-300 hidden md:table-cell">{cls.config?.systemTitle || '-'}</td>
                                                    <td className="p-4 text-gray-500 text-sm hidden sm:table-cell">{cls.lastUpdated}</td>
                                                    <td className="p-4 text-right space-x-2">
                                                        <button 
                                                            onClick={() => onEnterClass(cls.id)}
                                                            className="inline-flex items-center gap-1 px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold"
                                                        >
                                                            <Icon name="log-in" size={14} /> é€²å…¥
                                                        </button>
                                                        <button 
                                                            onClick={() => handleDelete(cls.id)}
                                                            className="inline-flex items-center gap-1 px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm font-bold"
                                                        >
                                                            <Icon name="trash-2" size={14} /> åˆªé™¤
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, onAdminLogin }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');

            // è‡ªå‹•å¡«å…¥æœ€å¾Œä¸€æ¬¡çš„ç­ç´šä»£ç¢¼
            useEffect(() => {
                const lastId = localStorage.getItem('last_active_classroom');
                if (lastId) {
                    setInput(lastId);
                }
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const code = input.trim();
                if (!code) { setError('è«‹è¼¸å…¥è€ƒå ´ä»£ç¢¼'); return; }
                
                try {
                    if (window.crypto && window.crypto.subtle) {
                        const hash = await sha256(code);
                        if (hash === ADMIN_HASH) {
                            onAdminLogin();
                            return;
                        }
                    } else {
                        if (code === 'Makima777') {
                             onAdminLogin();
                             return;
                        }
                    }
                } catch (e) {
                    console.warn("Hashing check skipped, using fallback", e);
                    if (code === 'Makima777') {
                         onAdminLogin();
                         return;
                    }
                }

                if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(code)) {
                    setError('è€ƒå ´ä»£ç¢¼åªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—æˆ–åº•ç·š');
                    return;
                }
                
                // å„²å­˜é€™æ¬¡çš„ä»£ç¢¼
                localStorage.setItem('last_active_classroom', code);
                onLogin(code);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-slate-100 p-4 select-none">
                    <div className="bg-slate-800 p-8 rounded-xl pixel-border border-4 border-gray-700 w-full max-w-md text-center shadow-2xl">
                        <div className="flex justify-center mb-6"><div className="p-4 bg-yellow-400 rounded-full border-4 border-yellow-600 shadow-lg"><Icon name="layout-grid" size={48} className="text-yellow-900" /></div></div>
                        <h1 className="text-3xl font-black tracking-widest text-white mb-2">åº§ä½ç·¨æ’ç³»çµ±</h1>
                        <p className="text-gray-400 mb-8 text-sm">è«‹è¼¸å…¥è€ƒå ´ä»£ç¢¼ä»¥å»ºç«‹æˆ–é€²å…¥</p>
                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                            <div className="relative">
                                <Icon name="key" size={20} className="absolute left-3 top-3 text-gray-500" />
                                <input type="text" value={input} onChange={(e) => {setInput(e.target.value); setError('');}} placeholder="ä¾‹å¦‚ï¼šClass302 æˆ– TeacherWang" className="w-full bg-slate-700 border-2 border-slate-600 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:bg-slate-600 transition-colors text-lg font-bold select-text" autoFocus />
                            </div>
                            {error && <p className="text-red-400 text-sm font-bold animate-pulse">{error}</p>}
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 mt-2"><Icon name="log-in" size={20} /> é€²å…¥ç·¨è¼¯</button>
                        </form>
                        <div className="mt-8 text-xs text-gray-500 border-t border-gray-700 pt-4"><p>ğŸ’¡ æç¤ºï¼šè¼¸å…¥ç›¸åŒçš„ä»£ç¢¼å³å¯åœ¨ä¸åŒé›»è…¦åŒæ­¥è³‡æ–™ã€‚</p></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle');
            // ç§»é™¤ currentTime å’Œ mode ç›¸é—œ state
            const [config, setConfig] = useState({ rows: 5, cols: 7, systemTitle: 'æœªå‘½åè€ƒå ´', defaultClass: '' });
            // ç§»é™¤ schedule ç›¸é—œ state
            const [rosterText, setRosterText] = useState(DEFAULT_ROSTER);
            const [rosterMap, setRosterMap] = useState({});
            const [availableClasses, setAvailableClasses] = useState([]);
            const [seats, setSeats] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [activeClassroom, setActiveClassroom] = useState(null);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [dataLoaded, setDataLoaded] = useState(false);
            const inputRefs = useRef({});

            const [helperClassName, setHelperClassName] = useState('');
            const [helperStudentList, setHelperStudentList] = useState('');
            const exportRef = useRef(null);
            const [isExporting, setIsExporting] = useState(false);

            const duplicateNumbers = useMemo(() => {
                const counts = {};
                Object.values(seats).forEach(s => { if (s.number) counts[s.number] = (counts[s.number] || 0) + 1; });
                return new Set(Object.keys(counts).filter(n => counts[n] > 1));
            }, [seats]);

            // èªè­‰é‚è¼¯
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed", err);
                        setSyncStatus('error');
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // è³‡æ–™è®€å–é‚è¼¯ (Load)
            useEffect(() => {
                if (!activeClassroom) return;
                
                setDataLoaded(false);

                const loadLocal = () => {
                    const savedLocal = localStorage.getItem(`examMonitorData_${activeClassroom}`);
                    if (savedLocal) {
                        try {
                            const parsed = JSON.parse(savedLocal);
                            // ç§»é™¤ config.date å’Œ schedule
                            if (parsed.config) setConfig(prev => ({...prev, ...parsed.config}));
                            if (parsed.rosterText) setRosterText(parsed.rosterText);
                            if (parsed.seats) setSeats(parsed.seats);
                        } catch(e) {}
                    }
                    setDataLoaded(true);
                };

                if (!isFirebaseConfigured || !user) {
                    loadLocal();
                    return;
                }

                setSyncStatus('loading');
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', activeClassroom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // ç§»é™¤ config.date å’Œ schedule
                        if (data.config) setConfig(prev => ({...prev, ...data.config}));
                        if (data.rosterText) setRosterText(data.rosterText);
                        if (data.seats) setSeats(data.seats);
                        setSyncStatus('idle');
                    } else {
                        // é›²ç«¯ç„¡è³‡æ–™ï¼Œè®€å–æœ¬åœ°
                        const savedLocal = localStorage.getItem(`examMonitorData_${activeClassroom}`);
                        if (savedLocal) {
                            try {
                                const parsed = JSON.parse(savedLocal);
                                setConfig(prev => ({...prev, ...(parsed.config || {})}));
                                setRosterText(prev => parsed.rosterText || prev);
                                setSeats(prev => parsed.seats || prev);
                            } catch(e){}
                        }
                        setSyncStatus('idle');
                    }
                    setDataLoaded(true);
                }, (error) => { 
                    console.error("Sync error", error); 
                    setSyncStatus('error');
                    loadLocal(); // é›²ç«¯éŒ¯èª¤æ™‚ï¼Œé€€å›æœ¬åœ°
                });
                return () => unsubscribe();
            }, [user, activeClassroom]);

            // è‡ªå‹•å­˜æª”é‚è¼¯ (Auto-Save to LocalStorage)
            useEffect(() => {
                if (!activeClassroom || !dataLoaded) return; 

                const timer = setTimeout(() => {
                    // ç§»é™¤ schedule
                    const dataToSave = { config, rosterText, seats };
                    localStorage.setItem(`examMonitorData_${activeClassroom}`, JSON.stringify(dataToSave));
                }, 1000); 

                return () => clearTimeout(timer);
            }, [activeClassroom, config, rosterText, seats, dataLoaded]);

            // åå–®è§£æé‚è¼¯
            useEffect(() => {
                console.groupCollapsed("ğŸ“‹ åå–®è§£æå ±å‘Š (Roster Parse Report)");
                const lines = rosterText.split('\n');
                const newMap = {};
                const foundClasses = new Set();
                let currentClass = null;
                let studentCount = 0;

                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;

                    const classMatch = trimmedLine.match(/^\[(.*)\]$/);
                    if (classMatch) {
                        currentClass = classMatch[1].trim();
                        foundClasses.add(currentClass);
                        console.log(`âœ… åˆ‡æ›ç­ç´š (Header): "${currentClass}"`);
                        return;
                    }

                    const parts = trimmedLine.split(/[\t,ï¼Œ\s]+/);

                    if (parts.length === 1) {
                        if (!/^\d+$/.test(parts[0])) {
                             currentClass = parts[0];
                             foundClasses.add(currentClass);
                             console.log(`âœ… åˆ‡æ›ç­ç´š (Simple): "${currentClass}"`);
                             return;
                        }
                    }

                    if (parts.length >= 2) {
                        const seatPart = parts[0]; 
                        const namePart = parts[1]; 
                        
                        let uniqueId = seatPart;
                        let className = null;

                        const isPureNumber = /^\d+$/.test(seatPart);
                        
                        if (currentClass && isPureNumber) {
                            uniqueId = `${currentClass}-${seatPart}`;
                            className = currentClass;
                        } else if (seatPart.includes('-')) {
                            const splitId = seatPart.split('-');
                            className = splitId[0];
                        } else if (currentClass) {
                             uniqueId = `${currentClass}-${seatPart}`;
                             className = currentClass;
                        }

                        newMap[uniqueId] = {
                            name: namePart,
                            className: className
                        };
                        studentCount++;
                        if (studentCount < 5 || index > lines.length - 5) {
                             console.log(`   ğŸ“ å°æ‡‰æˆåŠŸ: ID [${uniqueId}] -> ${namePart} (${className || 'ç„¡ç­ç´š'})`);
                        }
                    }
                });
                console.log(`ğŸ“Š ç¸½è¨ˆè§£æå­¸ç”Ÿæ•¸: ${studentCount}`);
                console.log("ğŸ”‘ æ‰€æœ‰å¯ç”¨ ID:", Object.keys(newMap));
                console.groupEnd();
                setRosterMap(newMap);
                setAvailableClasses(Array.from(foundClasses).sort());
            }, [rosterText]);


            const saveToCloud = async () => {
                if (!activeClassroom) return;
                // æ‰‹å‹•å„²å­˜æ™‚ä¹Ÿä¸€ä½µæ›´æ–°æœ¬åœ° (ç§»é™¤ schedule)
                localStorage.setItem(`examMonitorData_${activeClassroom}`, JSON.stringify({ config, rosterText, seats }));
                
                if (!isFirebaseConfigured || !user) { alert('å·²å„²å­˜è‡³æœ¬åœ° (æœªè¨­å®š Firebase)'); return; }
                setSyncStatus('saving');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', activeClassroom);
                    // ç§»é™¤ schedule
                    await setDoc(docRef, { config, rosterText, seats, lastUpdated: new Date().toISOString(), updatedBy: user.uid });
                    setSyncStatus('saved');
                    setTimeout(() => setSyncStatus('idle'), 2000);
                } catch (e) { console.error("Save failed:", e); setSyncStatus('error'); alert(`é›²ç«¯å„²å­˜å¤±æ•—: ${e.message}\nè«‹æª¢æŸ¥ Firebase è¦å‰‡`); }
            };

            const deleteClassroomData = async () => {
                if (!activeClassroom) return;
                // å¿…é ˆä½¿ç”¨è‡ªå®šç¾©æ¨¡æ…‹æ¡†æˆ–æ–‡å­—æç¤ºï¼Œé¿å…ä½¿ç”¨ window.confirm
                const confirmCode = prompt(`è­¦å‘Šï¼šé€™å°‡æœƒæ°¸ä¹…åˆªé™¤ã€Œ${activeClassroom}ã€çš„æ‰€æœ‰è³‡æ–™ï¼\n\nè«‹è¼¸å…¥ã€Œ${activeClassroom}ã€ä»¥ç¢ºèªï¼š`);
                if (confirmCode === activeClassroom) {
                    try {
                        setSyncStatus('saving');
                        if (isFirebaseConfigured && user) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classrooms', activeClassroom));
                        }
                        localStorage.removeItem(`examMonitorData_${activeClassroom}`);
                        alert('è³‡æ–™å·²åˆªé™¤ã€‚');
                        // ç§»é™¤ schedule
                        setSeats({}); setRosterText(DEFAULT_ROSTER); setActiveClassroom(null);
                    } catch (e) { console.error(e); alert('åˆªé™¤å¤±æ•—'); setSyncStatus('error'); }
                }
            };

            const handleClearSeats = () => {
                // å¿…é ˆä½¿ç”¨è‡ªå®šç¾©æ¨¡æ…‹æ¡†æˆ–æ–‡å­—æç¤ºï¼Œé¿å…ä½¿ç”¨ window.confirm
                if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åº§ä½å®‰æ’å—ï¼Ÿ\n\næ­¤å‹•ä½œå°‡ç§»é™¤æ‰€æœ‰æ ¼å­å…§çš„åº§è™Ÿèˆ‡ç­ç´šè¨­å®šï¼Œä»¥ä¾¿é‡æ–°å®‰æ’ã€‚')) {
                    setSeats({});
                }
            };

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else if (document.exitFullscreen) document.exitFullscreen();
            };

            const updateSeatNumber = (r, c, type, value) => {
                const key = `${r}-${c}`;
                const currentSeat = seats[key] || { number: '', status: 'empty' };
                const currentVal = currentSeat.number || '';
                
                let [currentClass, currentNum] = currentVal.includes('-') 
                    ? currentVal.split('-') 
                    : ['', currentVal];
                
                if (!currentVal.includes('-')) {
                    currentNum = currentVal;
                    currentClass = '';
                }

                let newClass = currentClass;
                let newNum = currentNum;

                if (type === 'class') newClass = value; 
                if (type === 'seat') {
                    newNum = value; 
                    // å¦‚æœæ­£åœ¨è¼¸å…¥åº§è™Ÿï¼Œä¸”é‚„æ²’æœ‰ç­ç´šï¼Œè‡ªå‹•å¥—ç”¨é è¨­ç­ç´š
                    if (!newClass && config.defaultClass && newNum.trim()) {
                        newClass = config.defaultClass;
                    }
                }

                let newVal = '';
                if (newClass && !newNum) newVal = `${newClass}-`;
                else if (!newClass && newNum) newVal = newNum;
                else if (newClass && newNum) newVal = `${newClass}-${newNum}`;
                else newVal = '';
                
                // ç§»é™¤ status é‚è¼¯ï¼Œç°¡åŒ–ç‚ºåªæœ‰ number
                setSeats(prev => ({ ...prev, [key]: { number: newVal } }));
            };

            const handleKeyDown = (e, r, c, type) => {
                let targetR = r; let targetC = c;
                if (e.key === 'Enter') {
                    if (type === 'class') {
                        // é€²å…¥åº§è™Ÿè¼¸å…¥æ¡†
                        const targetKey = `${r}-${c}-seat`;
                        if (inputRefs.current[targetKey]) { 
                            e.preventDefault(); 
                            inputRefs.current[targetKey].focus(); 
                        }
                        return;
                    }
                }

                if (e.key === 'ArrowUp') targetR = Math.max(0, r - 1);
                else if (e.key === 'ArrowDown') targetR = Math.min(config.rows - 1, r + 1);
                else if (e.key === 'ArrowLeft') targetC = Math.max(0, c - 1);
                else if (e.key === 'ArrowRight') targetC = Math.min(config.cols - 1, c + 1);
                else return;
                
                // å°å‘åˆ°ç›®æ¨™åº§ä½çš„åº§è™Ÿè¼¸å…¥æ¡†
                const targetKey = `${targetR}-${targetC}-seat`; 
                if (inputRefs.current[targetKey]) { 
                    e.preventDefault(); 
                    inputRefs.current[targetKey].focus(); 
                }
            };

            const handleAddClassToRoster = () => {
                if (!helperStudentList.trim()) return;
                
                let newText = rosterText.trim();
                if (newText) newText += '\n\n';
                
                if (helperClassName.trim()) {
                    newText += `[${helperClassName.trim()}]\n`;
                }
                
                newText += helperStudentList.trim();
                
                setRosterText(newText);
                setHelperClassName('');
                setHelperStudentList('');
            };

            // è¨ˆç®— Default Class æ˜¯å¦åˆæ³• (ä¿®æ­£ï¼šåŠ å…¥ trim)
            const isClassValid = !config.defaultClass || availableClasses.includes(config.defaultClass.trim());

            // ====================================================================
            // â–¼ PDF/åœ–ç‰‡ åŒ¯å‡ºé‚è¼¯ (æ–°çš„æ ¸å¿ƒåŠŸèƒ½) â–¼
            // ====================================================================
            const generatePdfContent = () => {
                const pdfContainer = document.getElementById('pdf-export-container');
                if (!pdfContainer) return;

                // 1. æ¸…ç©ºå®¹å™¨
                pdfContainer.innerHTML = '';
                
                // 2. æ¨™é¡Œ (ä½¿ç”¨ h1 ä»¥ç¢ºä¿å¤§å­—é«”)
                const title = document.createElement('h1');
                title.style.cssText = 'font-size: 24pt; font-weight: 900; margin-bottom: 20pt; color: #333; text-align: center;';
                title.textContent = config.systemTitle || activeClassroom || 'åº§ä½å®‰æ’è¡¨';
                pdfContainer.appendChild(title);

                // 3. ç¶²æ ¼å®¹å™¨
                const gridContainer = document.createElement('div');
                gridContainer.style.cssText = `
                    display: grid;
                    width: 100%;
                    /* è¨ˆç®—ç¶²æ ¼ä½ˆå±€ */
                    grid-template-columns: repeat(${config.cols}, 1fr);
                    gap: 5pt;
                    flex-grow: 1; /* è®“ç¶²æ ¼ä½”æ»¿å‰©é¤˜ç©ºé–“ */
                    max-height: 250mm; /* é¿å…è¶…é A4 é‚Šç•Œ */
                `;
                
                // 4. è¬›å¸«å€/è¬›å°æ¨™ç¤º
                const podium = document.createElement('div');
                podium.style.cssText = `
                    grid-column: 1 / -1;
                    height: 15mm;
                    background-color: #f1f1f1;
                    border: 2px solid #ccc;
                    border-radius: 4px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 14pt;
                    font-weight: 700;
                    color: #555;
                    margin-bottom: 10pt;
                `;
                podium.textContent = 'è¬›å° / è¬›å¸«å€ (Podium)';
                gridContainer.appendChild(podium);

                // 5. å¡«å……åº§ä½
                for (let r = 0; r < config.rows; r++) {
                    for (let c = 0; c < config.cols; c++) {
                        const key = `${r}-${c}`;
                        const seat = seats[key] || { number: '' };
                        const [classPart, seatPart] = seat.number.includes('-') 
                            ? seat.number.split('-') 
                            : ['', seat.number];
                        
                        const studentData = rosterMap[seat.number];
                        const studentName = studentData?.name || '';
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'pdf-grid-item';

                        // ç­ç´šæ¨™ç±¤
                        if (classPart.trim()) {
                            const classSpan = document.createElement('span');
                            classSpan.className = 'pdf-grid-item-class';
                            classSpan.textContent = classPart;
                            // åŒ¯å‡ºæ™‚ç„¡æ³•ä½¿ç”¨ Tailwind CSS é¡ï¼Œå¿…é ˆå…§è¯æ¨£å¼
                            const color = getClassColor(classPart).replace('bg-', 'var(--tw-bg-opacity, 1) #');
                            classSpan.style.backgroundColor = color.includes('#') ? color : 'rgb(59 130 246 / var(--tw-bg-opacity))'; // é è¨­è—è‰²
                            itemDiv.appendChild(classSpan);
                        }

                        // åº§è™Ÿ
                        const numberDiv = document.createElement('div');
                        numberDiv.className = 'pdf-grid-item-number';
                        numberDiv.textContent = seatPart.trim() || '-';
                        itemDiv.appendChild(numberDiv);

                        // å§“å
                        const nameDiv = document.createElement('div');
                        nameDiv.style.cssText = 'font-size: 12pt; font-weight: 400; color: #555; line-height: 1.2;';
                        nameDiv.textContent = studentName || '';
                        itemDiv.appendChild(nameDiv);

                        gridContainer.appendChild(itemDiv);
                    }
                }

                pdfContainer.appendChild(gridContainer);
                exportRef.current = pdfContainer;
            };

            const handleExportToPdf = async () => {
                setIsExporting(true);
                generatePdfContent(); // æº–å‚™ A4 å®¹å™¨å…§å®¹

                try {
                    // ä½¿ç”¨ html2canvas æ“·å–éš±è—çš„ A4 å®¹å™¨
                    const canvas = await html2canvas(exportRef.current, {
                        scale: 3, // æé«˜è§£æåº¦
                        logging: false,
                        useCORS: true,
                        // ç¢ºä¿èƒŒæ™¯å’Œæ–‡å­—é¡è‰²æ­£ç¢º
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    
                    // A4 å°ºå¯¸ (210 x 297 mm)
                    const pdf = new jsPDF('p', 'mm', 'a4'); 
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    // èª¿æ•´åœ–åƒå°ºå¯¸ä»¥ fit A4
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let finalImgHeight = imgHeight;
                    let yPos = 0;
                    
                    // å¦‚æœé«˜åº¦è¶…å‡º A4ï¼Œå‰‡ç¸®æ”¾
                    if (imgHeight > pdfHeight) {
                        finalImgHeight = pdfHeight - 10; // ç•™é»é‚Šè·
                        // é‡æ–°è¨ˆç®—å¯¬åº¦ä»¥ä¿æŒæ¯”ä¾‹
                        const finalImgWidth = (imgProps.width * finalImgHeight) / imgProps.height;
                        const xOffset = (pdfWidth - finalImgWidth) / 2;
                        pdf.addImage(imgData, 'PNG', xOffset, 5, finalImgWidth, finalImgHeight);
                    } else {
                        // å±…ä¸­æ”¾ç½®
                        yPos = (pdfHeight - imgHeight) / 2;
                        pdf.addImage(imgData, 'PNG', 0, yPos, pdfWidth, imgHeight);
                    }
                    
                    pdf.save(`${config.systemTitle || activeClassroom || 'åº§ä½è¡¨'}_${new Date().toISOString().slice(0, 10)}.pdf`);
                } catch (error) {
                    console.error('PDF åŒ¯å‡ºå¤±æ•—:', error);
                    alert('PDF åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨ç›¸å®¹æ€§ã€‚');
                } finally {
                    setIsExporting(false);
                }
            };

            const handleExportToImage = async () => {
                setIsExporting(true);
                generatePdfContent(); // æº–å‚™ A4 å®¹å™¨å…§å®¹

                try {
                    // ä½¿ç”¨ html2canvas æ“·å–éš±è—çš„ A4 å®¹å™¨
                    const canvas = await html2canvas(exportRef.current, {
                        scale: 3, // æé«˜è§£æåº¦
                        logging: false,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = imgData;
                    a.download = `${config.systemTitle || activeClassroom || 'åº§ä½è¡¨'}_${new Date().toISOString().slice(0, 10)}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('åœ–ç‰‡åŒ¯å‡ºå¤±æ•—:', error);
                    alert('åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨ç›¸å®¹æ€§ã€‚');
                } finally {
                    setIsExporting(false);
                }
            };
            // ====================================================================

            if (isAdminMode) return <AdminPanel onBack={() => setIsAdminMode(false)} onEnterClass={(id) => { setIsAdminMode(false); setActiveClassroom(id); }} />;
            if (!activeClassroom) return <LoginScreen onLogin={setActiveClassroom} onAdminLogin={() => setIsAdminMode(true)} />;

            return (
                <div className="h-screen w-screen flex flex-col bg-slate-900 text-slate-100 overflow-hidden font-mono select-none">
                    {/* Navbar */}
                    <div className="shrink-0 w-full bg-gray-300 text-gray-800 p-2 flex justify-between items-center border-b-4 border-gray-400 shadow-lg z-20 relative">
                        <div className="flex items-center gap-4">
                            <div className="flex gap-1 ml-2"><div className="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div><div className="w-3 h-3 rounded-full bg-yellow-500"></div><div className="w-3 h-3 rounded-full bg-green-500"></div></div>
                            <input 
                                type="text" 
                                className="font-black text-xl tracking-widest text-gray-700 bg-transparent border-b-2 border-gray-500 outline-none hidden md:block placeholder-gray-400 w-64 select-text" 
                                value={config.systemTitle || ''} 
                                placeholder="è«‹è¼¸å…¥åº§ä½è¡¨åç¨±" 
                                onChange={(e) => setConfig({...config, systemTitle: e.target.value})} 
                            />
                            <div className="hidden md:flex items-center gap-2 ml-2 border-l pl-4 border-gray-400 relative">
                                <span className="text-xs font-bold text-gray-500">é è¨­ç­ç´š:</span>
                                <div className="relative">
                                    <input 
                                        list="class-options"
                                        type="text" 
                                        className={`w-24 bg-white border-2 rounded px-2 py-1 text-sm font-bold placeholder-gray-300 focus:outline-none transition-colors ${!isClassValid ? 'border-red-500 text-red-600 focus:border-red-600' : 'border-gray-300 text-blue-600 focus:border-blue-500'}`} 
                                        placeholder="ä¾‹å¦‚:301" 
                                        value={config.defaultClass || ''} 
                                        onChange={(e) => setConfig({...config, defaultClass: e.target.value})} 
                                        title="è¼¸å…¥å¾Œï¼Œå¡«å¯«åº§è™Ÿæ™‚æœƒè‡ªå‹•å¸¶å…¥æ­¤ç­ç´š"
                                    />
                                    {!isClassValid && (
                                        <div className="absolute top-full left-0 mt-1 bg-red-500 text-white text-[10px] px-1 rounded whitespace-nowrap z-50 shadow-lg animate-bounce">
                                            âš ï¸ åå–®ç„¡æ­¤ç­ç´š
                                        </div>
                                    )}
                                </div>
                                <datalist id="class-options">
                                    {availableClasses.map(c => <option key={c} value={c} />)}
                                </datalist>
                            </div>

                            <button onClick={saveToCloud} disabled={syncStatus === 'saving'} className={`flex items-center gap-2 px-3 py-1 rounded-full border-inner shadow-inner transition-colors ${syncStatus === 'saved' ? 'bg-green-100' : 'bg-gray-200 hover:bg-gray-300'} ml-2`} title="æ‰‹å‹•å„²å­˜">
                                {syncStatus === 'loading' ? <Icon name="refresh-cw" className="animate-spin text-blue-500" size={14} /> : syncStatus === 'saving' ? <Icon name="cloud-upload" className="animate-bounce text-blue-500" size={14} /> : syncStatus === 'saved' ? <Icon name="check" className="text-green-600" size={14} /> : syncStatus === 'error' ? <Icon name="cloud-off" className="text-red-500" size={14} /> : <Icon name="save" className="text-gray-600" size={14} />}
                                <span className={`text-xs font-bold ${syncStatus === 'saved' ? 'text-green-700' : 'text-gray-600'}`}>{syncStatus === 'loading' ? 'è®€å–...' : syncStatus === 'saving' ? 'å„²å­˜ä¸­...' : syncStatus === 'saved' ? 'å·²å„²å­˜' : syncStatus === 'error' ? 'å¤±æ•—' : 'é»æ­¤å­˜æª”'}</span>
                            </button>

                            <button onClick={handleClearSeats} className="flex items-center gap-2 px-3 py-1 rounded-full border-inner shadow-inner transition-colors bg-red-100 hover:bg-red-200 ml-2" title="æ¸…ç©ºæ‰€æœ‰åº§ä½">
                                <Icon name="trash-2" className="text-red-600" size={14} />
                                <span className="text-xs font-bold text-red-700">æ¸…ç©ºåº§ä½</span>
                            </button>
                        </div>
                        <div className="flex gap-2">
                            {/* åŒ¯å‡ºæŒ‰éˆ•ç¾¤çµ„ */}
                            <div className="flex bg-gray-200 p-1 rounded-lg shadow-inner border border-gray-400">
                                <button 
                                    onClick={handleExportToPdf} 
                                    disabled={isExporting}
                                    className="px-4 py-1.5 rounded font-bold flex items-center gap-2 text-sm transition-all bg-red-500 text-white shadow-md hover:bg-red-600 disabled:bg-gray-400"
                                >
                                    {isExporting ? <Icon name="loader-2" className="animate-spin" size={16} /> : <Icon name="file-text" size={16} />} åŒ¯å‡º PDF (A4)
                                </button>
                                <button 
                                    onClick={handleExportToImage} 
                                    disabled={isExporting}
                                    className="px-4 py-1.5 rounded font-bold flex items-center gap-2 text-sm transition-all bg-green-500 text-white shadow-md hover:bg-green-600 disabled:bg-gray-400"
                                >
                                    {isExporting ? <Icon name="loader-2" className="animate-spin" size={16} /> : <Icon name="image" size={16} />} åŒ¯å‡ºåœ–ç‰‡
                                </button>
                            </div>
                            
                            <button onClick={toggleFullScreen} className="px-3 py-1.5 bg-gray-700 text-white rounded-lg font-bold border-b-4 border-gray-900 active:border-b-0 active:translate-y-1 transition-all flex items-center gap-2 text-sm"><Icon name="maximize" size={16} /> å…¨è¢å¹•</button>
                            <button onClick={() => setShowSettings(true)} className="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg border-b-4 border-gray-400 hover:bg-white active:border-b-0 active:translate-y-1 flex items-center gap-1 text-sm"><Icon name="settings" size={16} /> è¨­å®š</button>
                            <button onClick={() => setActiveClassroom(null)} className="px-3 py-1.5 bg-red-500 text-white rounded-lg font-bold border-b-4 border-red-700 hover:bg-red-400 active:border-b-0 active:translate-y-1 text-sm flex items-center" title="ç™»å‡º"><Icon name="log-out" size={16} /></button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex w-full overflow-hidden relative p-4 gap-4">
                        
                        {/* Left Section: Seat Grid */}
                        <div className="flex-1 bg-slate-800 rounded-xl p-2 md:p-4 pixel-border relative flex flex-col border-4 border-gray-700 overflow-hidden">
                            {/* Podium */}
                            <div className="w-full h-12 bg-amber-700 text-amber-100 rounded-lg border-b-4 border-amber-900 shadow-lg flex items-center justify-center relative overflow-hidden group mb-4 shrink-0">
                                <Icon name="monitor" size={32} />
                                <span className="ml-4 font-bold text-xl">è¬›å° / è¬›å¸«å€ (Podium)</span>
                            </div>

                            {/* Seat Grid */}
                            <div className="flex-1 w-full h-full pb-2 overflow-y-auto no-scrollbar">
                                <div className="grid gap-2 h-full w-full" style={{ gridTemplateColumns: `repeat(${config.cols}, 1fr)` }}>
                                    {Array.from({ length: config.rows }).map((_, r) => (
                                        Array.from({ length: config.cols }).map((_, c) => {
                                            const key = `${r}-${c}`;
                                            const seat = seats[key] || { number: '' };
                                            const studentData = rosterMap[seat.number];
                                            const studentName = studentData?.name || '';
                                            const className = studentData?.className || '';
                                            
                                            const isDuplicate = seat.number && duplicateNumbers.has(seat.number);

                                            const [editClass, editSeat] = seat.number.includes('-') 
                                                ? seat.number.split('-') 
                                                : ['', seat.number];

                                            const isCellClassValid = !editClass || availableClasses.includes(editClass.trim());

                                            let containerClasses = "relative w-full h-full p-1 rounded border-b-4 transition-all flex flex-col items-center justify-center shadow-lg select-none ";

                                            if (!isCellClassValid) {
                                                containerClasses += "bg-orange-500 border-orange-700 text-white"; 
                                            } else if (isDuplicate) {
                                                containerClasses += "bg-red-100 border-red-500 text-red-900 ring-2 ring-red-500";
                                            } else if (seat.number) {
                                                containerClasses += "bg-slate-100 border-slate-300 text-slate-900 hover:bg-white cursor-pointer";
                                            } else {
                                                containerClasses += "bg-slate-700 border-slate-900 opacity-30";
                                            }

                                            return (
                                                <div key={key} className={containerClasses}>
                                                    <div className="flex flex-col w-full items-center justify-center gap-1">
                                                        <input 
                                                            type="text"
                                                            placeholder={config.defaultClass || "ç­ç´š"}
                                                            className={`w-full text-center bg-transparent outline-none text-xs md:text-sm font-bold p-0 placeholder-gray-500 transition-colors ${!isCellClassValid ? 'text-white font-black placeholder-white/50' : (editClass ? 'text-blue-400' : 'text-gray-500')}`}
                                                            value={editClass}
                                                            onChange={(e) => updateSeatNumber(r, c, 'class', e.target.value)}
                                                            onKeyDown={(e) => handleKeyDown(e, r, c, 'class')}
                                                            title={!isCellClassValid ? "âš ï¸ åå–®ç„¡æ­¤ç­ç´š" : ""}
                                                        />
                                                        <input 
                                                            ref={el => inputRefs.current[`${key}-seat`] = el} 
                                                            type="text"
                                                            placeholder="åº§è™Ÿ"
                                                            className={`w-full text-center bg-transparent outline-none font-bold text-2xl md:text-4xl border-b border-gray-400/50 focus:border-blue-500 p-0 select-text ${!isCellClassValid ? 'text-white border-white/50' : (isDuplicate ? 'text-red-600 border-red-400' : (seat.number ? 'text-slate-900' : 'text-white'))}`} 
                                                            value={editSeat} 
                                                            onChange={(e) => updateSeatNumber(r, c, 'seat', e.target.value)} 
                                                            onKeyDown={(e) => handleKeyDown(e, r, c, 'seat')} 
                                                        />
                                                    </div>
                                                    
                                                    {className && (
                                                        <div className={`absolute top-1 left-1 class-badge ${getClassColor(className)} text-white`}>
                                                            {className}
                                                        </div>
                                                    )}

                                                    {seat.number && (
                                                        <div className={`text-sm md:text-xl font-bold truncate w-full text-center px-0.5 leading-tight mt-1 ${!isCellClassValid ? 'text-white' : (isDuplicate ? 'text-red-600' : 'text-slate-600')}`}>{studentName || ''}</div>
                                                    )}
                                                    
                                                    {isDuplicate && <div className="absolute top-1 right-1 bg-yellow-400 text-red-900 text-[10px] font-bold px-1 rounded shadow z-10 animate-pulse">é‡è¤‡!</div>}
                                                </div>
                                            );
                                        })
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Right Section: Roster Management */}
                        <div className="w-96 flex flex-col gap-4 shrink-0 h-full">
                            <div className="bg-amber-50 rounded-xl flex-1 p-4 pixel-border flex flex-col text-slate-800 overflow-hidden border-4 border-gray-700">
                                <h3 className="font-bold text-xl border-b-4 border-amber-200 pb-2 mb-3 flex items-center gap-2 text-amber-800 shrink-0"><Icon name="users" size={24} /> ç­ç´šåå–®èˆ‡å­¸ç”Ÿè³‡è¨Š</h3>
                                <p className="text-sm text-gray-500 mb-2">å·²è§£æç­ç´š: {availableClasses.join(', ') || 'ç„¡'}</p>
                                <div className="flex-1 overflow-y-auto no-scrollbar pr-2">
                                    <pre className="text-xs font-mono bg-white p-2 rounded border border-gray-300 whitespace-pre-wrap">{rosterText || 'è«‹åœ¨è¨­å®šä¸­è¼¸å…¥åå–®'}</pre>
                                </div>
                                <div className="shrink-0 mt-4 pt-2 border-t border-gray-300">
                                    <button onClick={() => setShowSettings(true)} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                                        <Icon name="edit" size={16} /> ç·¨è¼¯åå–®èˆ‡è€ƒå ´å¤§å°
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icon name="settings" className="text-gray-600" /> è€ƒå ´èˆ‡è³‡æ–™åº«è¨­å®š</h2><button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-gray-800">âœ•</button></div>
                                <div className="overflow-y-auto flex-1 space-y-6 pr-2">
                                    <section className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icon name="cloud" className="text-blue-600" /> é›²ç«¯è³‡æ–™åŒæ­¥ (Firebase)</h3>
                                        {isFirebaseConfigured ? (
                                            <>
                                                <p className="text-sm text-blue-600 mb-3">è³‡æ–™å°‡è‡ªå‹•å„²å­˜åœ¨æ‚¨çš„ Firebase å¸³è™Ÿä¸‹ã€‚</p>
                                                <button onClick={saveToCloud} disabled={syncStatus === 'saving'} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2 hover:bg-blue-700 disabled:opacity-50"><Icon name="cloud-upload" size={18} />{syncStatus === 'saving' ? 'å„²å­˜ä¸­...' : 'æ‰‹å‹•å„²å­˜ç›®å‰è¨­å®š'}</button>
                                            </>
                                        ) : (
                                            <p className="text-sm text-red-600">å°šæœªè¨­å®š Firebase Configã€‚</p>
                                        )}
                                    </section>
                                    <section className="bg-gray-50 p-4 rounded-lg">
                                        <h3 className="font-bold text-gray-700 mb-2">A. åº§ä½æ’åˆ—</h3>
                                        <div className="flex gap-4">
                                            <div className="flex flex-col gap-1">
                                                <label className="text-sm text-gray-500">åˆ—æ•¸</label>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => setConfig({...config, rows: Math.max(1, config.rows - 1)})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="minus" size={18}/></button>
                                                    <input type="number" className="w-16 text-center border rounded p-1 text-black font-bold" value={config.rows} onChange={(e) => setConfig({...config, rows: parseInt(e.target.value) || 1})} />
                                                    <button onClick={() => setConfig({...config, rows: config.rows + 1})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="plus" size={18}/></button>
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-sm text-gray-500">è¡Œæ•¸</label>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => setConfig({...config, cols: Math.max(1, config.cols - 1)})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="minus" size={18}/></button>
                                                    <input type="number" className="w-16 text-center border rounded p-1 text-black font-bold" value={config.cols} onChange={(e) => setConfig({...config, cols: parseInt(e.target.value) || 1})} />
                                                    <button onClick={() => setConfig({...config, cols: config.cols + 1})} className="p-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 active:scale-95 transition-all"><Icon name="plus" size={18}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                    
                                    <section>
                                        <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-2">B. ç­ç´šåå–®</h3>
                                        <div className="mb-2 space-y-4">
                                            {/* å¿«é€Ÿæ–°å¢ç²¾éˆ */}
                                            <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-3">
                                                <label className="font-bold text-indigo-800 mb-2 block flex items-center gap-2">
                                                    <Icon name="wand-2" size={16} /> å¿«é€Ÿæ–°å¢ç­ç´š (Class Generator)
                                                </label>
                                                <div className="flex gap-2 mb-2">
                                                    <div className="flex-1">
                                                        <input 
                                                            type="text" 
                                                            className="w-full border border-indigo-200 rounded px-3 py-2 text-sm text-black placeholder-gray-400 focus:outline-none focus:border-indigo-500"
                                                            placeholder="ç­ç´šåç¨± (ä¾‹å¦‚: 301, é«˜ä¸€ä»...)" 
                                                            value={helperClassName}
                                                            onChange={(e) => setHelperClassName(e.target.value)}
                                                        />
                                                    </div>
                                                </div>
                                                <textarea 
                                                    className="w-full h-24 p-3 border border-indigo-200 rounded font-mono text-sm bg-white focus:outline-none focus:border-indigo-500 text-gray-800 mb-2 placeholder-gray-400" 
                                                    placeholder="åœ¨æ­¤è²¼ä¸Šè©²ç­çš„åº§è™Ÿèˆ‡å§“å..." 
                                                    value={helperStudentList} 
                                                    onChange={(e) => setHelperStudentList(e.target.value)} 
                                                />
                                                <button 
                                                    onClick={handleAddClassToRoster}
                                                    disabled={!helperStudentList.trim()}
                                                    className="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-sm transition-all"
                                                >
                                                    <Icon name="plus-circle" size={16} /> åŠ å…¥åˆ°ä¸‹æ–¹ç¸½åå–®
                                                </button>
                                            </div>

                                            <div className="relative py-2">
                                                <div className="absolute inset-0 flex items-center" aria-hidden="true">
                                                    <div className="w-full border-t border-gray-300"></div>
                                                </div>
                                                <div className="relative flex justify-center">
                                                    <span className="bg-white px-2 text-xs text-gray-400 font-bold">æˆ–æ˜¯ç›´æ¥ç·¨è¼¯åŸå§‹è³‡æ–™ (RAW DATA)</span>
                                                </div>
                                            </div>

                                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                                <label className="text-sm font-bold text-gray-600 block mb-1">å®Œæ•´åå–®å…§å®¹ (æ ¼å¼: [ç­ç´š]\nåº§è™Ÿ\tå§“å)</label>
                                                <textarea 
                                                    className="w-full h-32 p-3 border rounded font-mono text-sm bg-white focus:ring-2 focus:ring-green-500 outline-none text-gray-800 select-text" 
                                                    placeholder="[ç­ç´šåç¨±] (æ›è¡Œ) [åº§è™Ÿ] [å§“å]..." 
                                                    value={rosterText} 
                                                    onChange={(e) => setRosterText(e.target.value)} 
                                                />
                                            </div>
                                            
                                        </div>
                                    </section>
                                    
                                    <section className="bg-red-50 p-4 rounded-lg border border-red-200 mt-4">
                                        <h3 className="font-bold text-red-800 mb-2 flex items-center gap-2"><Icon name="shield-alert" className="text-red-600" /> ç®¡ç†å“¡å°ˆå€</h3>
                                        <p className="text-sm text-red-700 mb-3">æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ç•¶å‰è€ƒå ´ã€Œ{activeClassroom}ã€çš„æ‰€æœ‰è³‡æ–™ã€‚</p>
                                        <button onClick={deleteClassroomData} className="w-full bg-red-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2 hover:bg-red-700 font-bold"><Icon name="trash-2" size={18} /> åˆªé™¤æ­¤è€ƒå ´è³‡æ–™</button>
                                    </section>
                                </div>
                                <div className="mt-6 flex justify-between items-center pt-4 border-t"><span className="text-xs text-gray-400">{user ? `ID: ${user.uid.slice(0,8)}...` : 'æœ¬åœ°æ¨¡å¼'}</span><button onClick={() => {saveToCloud(); setShowSettings(false);}} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg">å„²å­˜ä¸¦é—œé–‰</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
